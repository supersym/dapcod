<!DOCTYPE html><html lang="en"><head><title>src/lib/models/document</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="src/lib/models/document"><meta name="groc-project-path" content="src/lib/models/document.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/lib/models/document.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p>Necessary</p></div></div><div class="code"><div class="wrapper"><span class="nv">pathUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
<span class="nv">balUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;bal-util&#39;</span><span class="p">)</span>
<span class="nv">_ = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;underscore&#39;</span><span class="p">)</span>
<span class="nv">mime = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;mime&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Optional</p></div></div><div class="code"><div class="wrapper"><span class="nv">CSON = </span><span class="kc">null</span>
<span class="nv">YAML = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Local</p></div></div><div class="code"><div class="wrapper"><span class="nv">FileModel = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/file&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Document Model</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">DocumentModel</span> <span class="k">extends</span> <span class="nx">FileModel</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Model Type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">type: </span><span class="s">&#39;document&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Attributes</p></div></div><div class="code"><div class="wrapper">  <span class="nv">defaults:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Special variables</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>outExtension
The final extension used for our file
Takes into accounts layouts
"layout.html", "post.md.eco" -> "html"
already defined in file.coffee</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Whether or not we reference other doucments</p></div></div><div class="code"><div class="wrapper">    <span class="nv">referencesOthers: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Content variables</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The file meta data (header) in string format before it has been parsed</p></div></div><div class="code"><div class="wrapper">    <span class="nv">header: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The parser to use for the file's meta data (header)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">parser: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The file content (body) before rendering, excludes the meta data (header)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">body: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Have we been rendered yet?</p></div></div><div class="code"><div class="wrapper">    <span class="nv">rendered: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The rendered content (after it has been wrapped in the layouts)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">contentRendered: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The rendered content (before being passed through the layouts)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">contentRenderedWithoutLayouts: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>User set variables</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Whether or not this file should be re-rendered on each request</p></div></div><div class="code"><div class="wrapper">    <span class="nv">dynamic: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The tags for this document</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tags: </span><span class="kc">null</span>  <span class="c1"># Array</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Whether or not we want to render single extensions</p></div></div><div class="code"><div class="wrapper">    <span class="nv">renderSingleExtensions: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Helpers</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Out Content</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getOutContent: </span><span class="nf">-&gt;</span>
    <span class="nv">content = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;contentRendered&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@getBuffer</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">content</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To JSON</p></div></div><div class="code"><div class="wrapper">  <span class="nv">toJSON: </span><span class="nf">-&gt;</span>
    <span class="nv">data = </span><span class="k">super</span>
    <span class="nv">data.meta = </span><span class="nx">@getMeta</span><span class="p">().</span><span class="nx">toJSON</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">data</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>References Others</p></div></div><div class="code"><div class="wrapper">  <span class="nv">referencesOthers: </span><span class="nf">(flag) -&gt;</span>
    <span class="nx">flag</span> <span class="o">?=</span> <span class="kc">true</span>
    <span class="nx">@set</span><span class="p">({</span><span class="nx">referencesOthers</span><span class="o">:</span><span class="nx">flag</span><span class="p">})</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Actions</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse
Parse our buffer and extract some meaningful data from it
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parse: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">buffer = </span><span class="nx">@getBuffer</span><span class="p">()</span>
    <span class="nv">meta = </span><span class="nx">@getMeta</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Wipe any meta attributes that we've copied over to our file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">reset = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="k">own</span> <span class="nx">key</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">attributes</span>
      <span class="nx">reset</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@defaults</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nv">reset = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">dereference</span><span class="p">(</span><span class="nx">reset</span><span class="p">)</span>
    <span class="nx">@set</span><span class="p">(</span><span class="nx">reset</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Then wipe the layout and clear the meta attributes from the meta model</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@layout = </span><span class="kc">null</span>
    <span class="nx">meta</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Reparse the data and extract the content
With the content, fetch the new meta data, header, and body</p></div></div><div class="code"><div class="wrapper">    <span class="k">super</span> <span class="nx">buffer</span><span class="p">,</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Content</p></div></div><div class="code"><div class="wrapper">      <span class="nv">content = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Meta Data</p></div></div><div class="code"><div class="wrapper">      <span class="nv">regex = </span><span class="sr">///</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>allow some space</p></div></div><div class="code"><div class="wrapper"><span class="sr">        ^\s*</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>discover our seperator</p></div></div><div class="code"><div class="wrapper"><span class="sr">        (</span>
<span class="sr">          ([^\s\d\w])\2{2,} # match a symbol character repeated 3 or more times</span>
<span class="sr">        ) #\1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>discover our parser</p></div></div><div class="code"><div class="wrapper"><span class="sr">        (?:</span>
<span class="sr">          \x20* # allow zero or more space characters, see https://github.com/jashkenas/coffee-script/issues/2668</span>
<span class="sr">          (</span>
<span class="sr">            [a-z]+  # parser must be lowercase alpha</span>
<span class="sr">          ) #\3</span>
<span class="sr">        )?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>discover our meta content</p></div></div><div class="code"><div class="wrapper"><span class="sr">        (</span>
<span class="sr">          [\s\S]*? # match anything/everything lazily</span>
<span class="sr">        ) #\4</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>match our seperator (the first group) exactly</p></div></div><div class="code"><div class="wrapper"><span class="sr">        \1</span>
<span class="sr">        ///</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract Meta Data</p></div></div><div class="code"><div class="wrapper">      <span class="nv">match = </span><span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">match</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">        <span class="nv">seperator = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">parser = </span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">or</span> <span class="s">&#39;yaml&#39;</span>
        <span class="nv">header = </span><span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
        <span class="nv">body = </span><span class="nx">content</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse</p></div></div><div class="code"><div class="wrapper">        <span class="k">try</span>
          <span class="k">switch</span> <span class="nx">parser</span>
            <span class="k">when</span> <span class="s">&#39;cson&#39;</span><span class="p">,</span> <span class="s">&#39;coffee&#39;</span><span class="p">,</span> <span class="s">&#39;coffeescript&#39;</span><span class="p">,</span> <span class="s">&#39;coffee-script&#39;</span>
              <span class="nv">CSON = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;cson&#39;</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">CSON</span>
              <span class="nv">metaData = </span><span class="nx">CSON</span><span class="p">.</span><span class="nx">parseSync</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span>
              <span class="nx">meta</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">metaData</span><span class="p">)</span>

            <span class="k">when</span> <span class="s">&#39;yaml&#39;</span>
              <span class="nv">YAML = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;yamljs&#39;</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">YAML</span>
              <span class="nv">metaData = </span><span class="nx">YAML</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span>
              <span class="nx">meta</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">metaData</span><span class="p">)</span>

            <span class="k">else</span>
              <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Unknown meta parser: </span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
              <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">err</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">body = </span><span class="nx">content</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update meta data</p></div></div><div class="code"><div class="wrapper">      <span class="nv">body = </span><span class="nx">body</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\n+/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="nx">@set</span><span class="p">(</span>
        <span class="nv">source: </span><span class="nx">content</span>
        <span class="nv">content: </span><span class="nx">body</span>
        <span class="nv">header: </span><span class="nx">header</span>
        <span class="nv">body: </span><span class="nx">body</span>
        <span class="nv">parser: </span><span class="nx">parser</span>
        <span class="nv">name: </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;basename&#39;</span><span class="p">)</span>
      <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Correct data format</p></div></div><div class="code"><div class="wrapper">      <span class="nv">metaDate = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">metaDate</span>
        <span class="nv">metaDate = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">metaDate</span><span class="p">)</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">date</span><span class="o">:</span><span class="nx">metaDate</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Correct ignore</p></div></div><div class="code"><div class="wrapper">      <span class="nv">ignored = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;ignored&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;skip&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;draft&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;published&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="kc">false</span><span class="p">)</span>
      <span class="nx">meta</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">ignored</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>  <span class="k">if</span> <span class="nx">ignored</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle urls</p></div></div><div class="code"><div class="wrapper">      <span class="nv">metaUrls = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;urls&#39;</span><span class="p">)</span>
      <span class="nv">metaUrl = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">)</span>
      <span class="nx">@addUrl</span><span class="p">(</span><span class="nx">metaUrls</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">metaUrls</span>
      <span class="nx">@addUrl</span><span class="p">(</span><span class="nx">metaUrl</span><span class="p">)</span>   <span class="k">if</span> <span class="nx">metaUrl</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply meta to us</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@set</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">      <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Normalize data
Normalize any parsing we have done, as if a value has updates it may have consequences on another value. This will ensure everything is okay.
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">normalize: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Super</p></div></div><div class="code"><div class="wrapper">    <span class="k">super</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract</p></div></div><div class="code"><div class="wrapper">      <span class="nv">extensions = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;extensions&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extension Rendered</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">extensions</span><span class="o">?</span> <span class="o">and</span> <span class="nx">extensions</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">outExtension = </span><span class="nx">extensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">@set</span><span class="p">({</span><span class="nx">outExtension</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">      <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Contextualize data
Put our data into perspective of the bigger picture. For instance, generate the url for it's rendered equivalant.
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">contextualize: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Super</p></div></div><div class="code"><div class="wrapper">    <span class="k">super</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get our highest ancestor</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@getEve</span> <span class="nf">(err,eve) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">        <span class="nv">changes = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch</p></div></div><div class="code"><div class="wrapper">        <span class="nv">meta = </span><span class="nx">@getMeta</span><span class="p">()</span>
        <span class="nv">fullPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span>
        <span class="nv">basename = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;basename&#39;</span><span class="p">)</span>
        <span class="nv">relativeDirPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;relativeDirPath&#39;</span><span class="p">)</span>
        <span class="nv">extensions = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;extensions&#39;</span><span class="p">)</span>
        <span class="nv">outExtension = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;outExtension&#39;</span><span class="p">)</span>
        <span class="nv">url = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">name = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">outPath = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;outPath&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">outFilename = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use our eve's rendered extension if it exists</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">eve</span><span class="o">?</span>
          <span class="nv">outExtension = </span><span class="nx">eve</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;outExtension&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Figure out the rendered filename</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">basename</span> <span class="o">and</span> <span class="nx">outExtension</span>
          <span class="k">if</span> <span class="nx">basename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;.&#39;</span> <span class="o">and</span> <span class="nx">outExtension</span> <span class="o">is</span> <span class="nx">extensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nv">outFilename = </span><span class="nx">basename</span>
          <span class="k">else</span>
            <span class="nv">outFilename = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">basename</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">outExtension</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="nv">changes.outFilename = </span><span class="nx">outFilename</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Figure out the rendered url</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">outFilename</span>
          <span class="k">if</span> <span class="nx">relativeDirPath</span>
            <span class="nv">relativeOutPath = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">relativeDirPath</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">outFilename</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="k">else</span>
            <span class="nv">relativeOutPath = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">outFilename</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="nv">changes.relativeOutPath = </span><span class="nx">relativeOutPath</span>
          <span class="k">unless</span> <span class="nx">url</span>
            <span class="nv">changes.url = url = </span><span class="s">&quot;/</span><span class="si">#{</span><span class="nx">relativeOutPath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set name if it doesn't exist already</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="o">!</span><span class="nx">name</span> <span class="o">and</span> <span class="nx">outFilename</span><span class="o">?</span>
          <span class="nv">changes.name = name = </span><span class="nx">outFilename</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the outPath if we have a outpute directory</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">@outDirPath</span>
          <span class="nv">changes.outPath = outPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@outDirPath</span><span class="p">,</span><span class="nx">relativeOutPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update the URL</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">url</span>
          <span class="nx">@removeUrl</span><span class="p">(</span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">))</span>
          <span class="nx">@setUrl</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Content Types</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">outPath</span> <span class="o">or</span> <span class="nx">fullPath</span>
          <span class="nv">changes.outContentType = outContentType = </span><span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">outPath</span> <span class="o">or</span> <span class="nx">fullPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">        <span class="nx">@set</span><span class="p">(</span><span class="nx">changes</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">        <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Layouts</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Has Layout
Checks if the file has a layout</p></div></div><div class="code"><div class="wrapper">  <span class="nv">hasLayout: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;layout&#39;</span><span class="p">)</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Layout
The the layout object that this file references (if any)
next(err,layout)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getLayout: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">layoutId = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;layout&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>No layout</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">layoutId</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cached layout</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span> <span class="k">if</span> <span class="nx">@layout</span> <span class="o">and</span> <span class="nx">layoutId</span> <span class="o">is</span> <span class="nx">@layout</span><span class="p">.</span><span class="nx">id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">@layout</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Uncached layout</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Find parent</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@emit</span> <span class="s">&#39;getLayout&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">layoutId</span><span class="p">},</span> <span class="nf">(err,opts) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">        <span class="p">{</span><span class="nx">layout</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">err</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Not Found</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span> <span class="k">unless</span> <span class="nx">layout</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Could not find the specified layout: </span><span class="si">#{</span><span class="nx">layoutId</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Found</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update our layout id with the definitive correct one</p></div></div><div class="code"><div class="wrapper">          <span class="nx">file</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;layout&#39;</span><span class="o">:</span> <span class="nx">layout</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cache our layout</p></div></div><div class="code"><div class="wrapper">          <span class="nv">file.layout = </span><span class="nx">layout</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">layout</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Eve
Get the most ancestoral layout we have (the very top one)
next(err,layout)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getEve: </span><span class="nf">(next) -&gt;</span>
    <span class="k">if</span> <span class="nx">@hasLayout</span><span class="p">()</span>
      <span class="nx">@getLayout</span> <span class="nf">(err,layout) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">layout</span><span class="p">.</span><span class="nx">getEve</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">@</span><span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Rendering</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render extensions
next(err,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderExtensions: </span><span class="nf">(opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">extensions = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;extensions&#39;</span><span class="p">)</span>
    <span class="nv">filename = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">)</span>
    <span class="p">{</span><span class="nx">content</span><span class="p">,</span><span class="nx">templateData</span><span class="p">,</span><span class="nx">renderSingleExtensions</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span>
    <span class="nx">content</span> <span class="o">?=</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
    <span class="nx">templateData</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="nx">renderSingleExtensions</span> <span class="o">?=</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;renderSingleExtensions&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare result</p></div></div><div class="code"><div class="wrapper">    <span class="nv">result = </span><span class="nx">content</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare extensions</p></div></div><div class="code"><div class="wrapper">    <span class="nv">extensionsReversed = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="nx">extensions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">filename</span>
      <span class="nx">extensionsReversed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">extension</span> <span class="k">in</span> <span class="nx">extensions</span>
      <span class="nx">extensionsReversed</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">extension</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we want to allow rendering of single extensions, then add null to the extension list</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">renderSingleExtensions</span> <span class="o">and</span> <span class="nx">extensionsReversed</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nx">renderSingleExtensions</span> <span class="o">isnt</span> <span class="s">&#39;auto&#39;</span> <span class="o">or</span> <span class="nx">filename</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\./</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="nx">extensionsReversed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">extensionsReversed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we only have one extension, then skip ahead to rendering layouts</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">extensionsReversed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare the tasks</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward with result</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cycle through all the extension groups and render them</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="nx">extension</span><span class="p">,</span><span class="nx">index</span> <span class="k">in</span> <span class="nx">extensionsReversed</span><span class="p">[</span><span class="mi">1</span><span class="p">..]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Push the task</p></div></div><div class="code"><div class="wrapper">      <span class="nv">context =</span>
        <span class="nv">inExtension: </span><span class="nx">extensionsReversed</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
        <span class="nv">outExtension: </span><span class="nx">extension</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nx">context</span><span class="p">,</span> <span class="nf">(complete) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">        <span class="nv">eventData =</span>
          <span class="nv">inExtension: </span><span class="nx">@inExtension</span>
          <span class="nv">outExtension: </span><span class="nx">@outExtension</span>
          <span class="nv">templateData: </span><span class="nx">templateData</span>
          <span class="nv">file: </span><span class="nx">file</span>
          <span class="nv">content: </span><span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render</p></div></div><div class="code"><div class="wrapper">        <span class="nx">file</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;render&#39;</span><span class="p">,</span> <span class="nx">eventData</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if the render did anything
and only check if we actually have content to render!
if this check fails, error with a suggestion</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">result</span> <span class="o">and</span> <span class="nx">result</span> <span class="o">is</span> <span class="nx">eventData</span><span class="p">.</span><span class="nx">content</span>
            <span class="nv">message = </span><span class="s">&quot;\n  Rendering the extension \&quot;</span><span class="si">#{</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">inExtension</span><span class="si">}</span><span class="s">\&quot; to \&quot;</span><span class="si">#{</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">outExtension</span><span class="si">}</span><span class="s">\&quot; on \&quot;</span><span class="si">#{</span><span class="nx">file</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">relativePath</span> <span class="o">or</span> <span class="nx">file</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">\&quot; didn&#39;t do anything.\n  Explanation here: http://docpad.org/extension-not-rendering&quot;</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The render did something, so apply and continue</p></div></div><div class="code"><div class="wrapper">          <span class="nv">result = </span><span class="nx">eventData</span><span class="p">.</span><span class="nx">content</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run tasks synchronously</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Document
next(err,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderDocument: </span><span class="nf">(opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">extension = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;extensions&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="p">{</span><span class="nx">content</span><span class="p">,</span><span class="nx">templateData</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span>
    <span class="nx">content</span> <span class="o">?=</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
    <span class="nx">templateData</span> <span class="o">?=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare event data</p></div></div><div class="code"><div class="wrapper">    <span class="nv">eventData = </span><span class="p">{</span><span class="nx">extension</span><span class="p">,</span><span class="nx">templateData</span><span class="p">,</span><span class="nx">file</span><span class="p">,</span><span class="nx">content</span><span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render via plugins</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;renderDocument&#39;</span><span class="p">,</span> <span class="nx">eventData</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Layouts
next(err,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderLayouts: </span><span class="nf">(opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="p">{</span><span class="nx">content</span><span class="p">,</span><span class="nx">templateData</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span>
    <span class="nx">content</span> <span class="o">?=</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
    <span class="nx">templateData</span> <span class="o">?=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Grab the layout</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">getLayout</span> <span class="nf">(err,layout) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">content</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we have a layout</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">layout</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Assign the current rendering to the templateData.content</p></div></div><div class="code"><div class="wrapper">        <span class="nv">templateData.content = </span><span class="nx">content</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Merge in the layout meta data into the document JSON
and make the result available via documentMerged
templateData.document.metaMerged = _.extend({}, layout.getMeta().toJSON(), file.getMeta().toJSON())</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render the layout with the templateData</p></div></div><div class="code"><div class="wrapper">        <span class="nx">layout</span><span class="p">.</span><span class="nx">render</span> <span class="p">{</span><span class="nx">templateData</span><span class="p">},</span> <span class="nf">(err,result) -&gt;</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We don't have a layout, nothing to do here</p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">content</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render
Render this file
next(err,result,document)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">render: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">contentRenderedWithoutLayouts = </span><span class="kc">null</span>
    <span class="nv">fullPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare options</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">opts = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">opts</span> <span class="o">or</span> <span class="p">{})</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">actions</span> <span class="o">?=</span> <span class="p">[</span><span class="s">&#39;renderExtensions&#39;</span><span class="p">,</span><span class="s">&#39;renderDocument&#39;</span><span class="p">,</span><span class="s">&#39;renderLayouts&#39;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare content</p></div></div><div class="code"><div class="wrapper">    <span class="nx">opts</span><span class="p">.</span><span class="nx">content</span> <span class="o">?=</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare templateData</p></div></div><div class="code"><div class="wrapper">    <span class="nv">opts.templateData = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">templateData</span> <span class="o">or</span> <span class="p">{})</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">templateData</span><span class="p">.</span><span class="nb">document</span> <span class="o">?=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">templateData</span><span class="p">.</span><span class="nx">documentModel</span> <span class="o">?=</span> <span class="nx">file</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare result
file.set({contentRendered:null, contentRenderedWithoutLayouts:null, rendered:false})</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Rendering the file: </span><span class="si">#{</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare the tasks</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="s">&quot;Something went wrong while rendering: </span><span class="si">#{</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">      <span class="nv">contentRendered = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">content</span>
      <span class="nx">contentRenderedWithoutLayouts</span> <span class="o">?=</span> <span class="nx">contentRendered</span>
      <span class="nv">rendered = </span><span class="kc">true</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">contentRendered</span><span class="p">,</span> <span class="nx">contentRenderedWithoutLayouts</span><span class="p">,</span> <span class="nx">rendered</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Rendering completed for: </span><span class="si">#{</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Success</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Extensions Task</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="s">&#39;renderExtensions&#39;</span> <span class="k">in</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">actions</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">renderExtensions</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(err,result) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply the result</p></div></div><div class="code"><div class="wrapper">          <span class="nv">opts.content = </span><span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Document Task</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="s">&#39;renderDocument&#39;</span> <span class="k">in</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">actions</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">renderDocument</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(err,result) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply the result</p></div></div><div class="code"><div class="wrapper">          <span class="nv">opts.content = </span><span class="nx">result</span>
          <span class="nv">contentRenderedWithoutLayouts = </span><span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Layouts Task</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="s">&#39;renderLayouts&#39;</span> <span class="k">in</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">actions</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">renderLayouts</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(err,result) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply the result</p></div></div><div class="code"><div class="wrapper">          <span class="nv">opts.content = </span><span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire the tasks</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>CRUD</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write the rendered file
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">writeRendered: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">fileOutPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;outPath&#39;</span><span class="p">)</span>
    <span class="nv">encoding = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span>
    <span class="nv">outContent = </span><span class="nx">@getOutContent</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Writing the rendered file: </span><span class="si">#{</span><span class="nx">fileOutPath</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">encoding</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write data</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">fileOutPath</span><span class="p">,</span> <span class="nx">outContent</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Wrote the rendered file: </span><span class="si">#{</span><span class="nx">fileOutPath</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">encoding</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write the file
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">writeSource: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">meta = </span><span class="nx">@getMeta</span><span class="p">()</span>
    <span class="nv">CSON = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;cson&#39;</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">CSON</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch</p></div></div><div class="code"><div class="wrapper">    <span class="nv">fullPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span>
    <span class="nv">content = </span><span class="p">(</span><span class="nx">@getContent</span><span class="p">()</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nv">parser = </span><span class="s">&#39;cson&#39;</span>
    <span class="nv">seperator = </span><span class="s">&#39;---&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Writing the source file: </span><span class="si">#{</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Adjust</p></div></div><div class="code"><div class="wrapper">    <span class="nv">metaData = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span><span class="nx">metaData</span><span class="p">})</span>
    <span class="nv">header = </span><span class="nx">CSON</span><span class="p">.</span><span class="nx">stringifySync</span><span class="p">(</span><span class="nx">metaData</span><span class="p">)</span>
    <span class="nv">content = body = </span><span class="nx">content</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="nv">source = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">seperator</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s">\n</span><span class="si">#{</span><span class="nx">header</span><span class="si">}</span><span class="s">\n</span><span class="si">#{</span><span class="nx">seperator</span><span class="si">}</span><span class="s">\n\n</span><span class="si">#{</span><span class="nx">body</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@set</span><span class="p">({</span><span class="nx">parser</span><span class="p">,</span><span class="nx">header</span><span class="p">,</span><span class="nx">body</span><span class="p">,</span><span class="nx">content</span><span class="p">,</span><span class="nx">source</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write content</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">fullPath</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="s">&quot;Wrote the source file: </span><span class="si">#{</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">      <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Export</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports = </span><span class="nx">DocumentModel</span></div></div></div></div></body></html>