<!DOCTYPE html><html lang="en"><head><title>src/lib/models/file</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="src/lib/models/file"><meta name="groc-project-path" content="src/lib/models/file.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/lib/models/file.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p>Requires</p></div></div><div class="code"><div class="wrapper"><span class="nv">pathUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
<span class="nv">balUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;bal-util&#39;</span><span class="p">)</span>
<span class="nv">mime = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;mime&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Local</p></div></div><div class="code"><div class="wrapper"><span class="p">{</span><span class="nx">Backbone</span><span class="p">,</span><span class="nx">Model</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/../base&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>File Model</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">FileModel</span> <span class="k">extends</span> <span class="nx">Model</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Properties</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The out directory path to put the file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">outDirPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Model Type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">type: </span><span class="s">&#39;file&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stat Object</p></div></div><div class="code"><div class="wrapper">  <span class="nv">stat: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>File data
When we do not have a path to scan
we can just pass over some data instead</p></div></div><div class="code"><div class="wrapper">  <span class="nv">data: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>File buffer</p></div></div><div class="code"><div class="wrapper">  <span class="nv">buffer: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The parsed file meta data (header)
Is a Backbone.Model instance</p></div></div><div class="code"><div class="wrapper">  <span class="nv">meta: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Attributes</p></div></div><div class="code"><div class="wrapper">  <span class="nv">defaults:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Automaticly set variables</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The unique document identifier</p></div></div><div class="code"><div class="wrapper">    <span class="nv">id: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The file's name without the extension</p></div></div><div class="code"><div class="wrapper">    <span class="nv">basename: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The file's last extension
"hello.md.eco" -> "eco"</p></div></div><div class="code"><div class="wrapper">    <span class="nv">extension: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The extension used for our output file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">outExtension: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The file's extensions as an array
"hello.md.eco" -> ["md","eco"]</p></div></div><div class="code"><div class="wrapper">    <span class="nv">extensions: </span><span class="kc">null</span>  <span class="c1"># Array</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The file's name with the extension</p></div></div><div class="code"><div class="wrapper">    <span class="nv">filename: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The full path of our source file, only necessary if called by @load
@TODO: rename to <code>path</code> in next major breaking version</p></div></div><div class="code"><div class="wrapper">    <span class="nv">path: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The output path of our file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">outPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The full directory path of our source file
@TODO: rename to <code>dirPath</code> in next major breaking version</p></div></div><div class="code"><div class="wrapper">    <span class="nv">dirPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The output path of our file's directory</p></div></div><div class="code"><div class="wrapper">    <span class="nv">outDirPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The file's name with the rendered extension</p></div></div><div class="code"><div class="wrapper">    <span class="nv">outFilename: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The relative path of our source file (with extensions)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">relativePath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The relative output path of our file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">relativeOutPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The relative directory path of our source file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">relativeDirPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The relative output path of our file's directory</p></div></div><div class="code"><div class="wrapper">    <span class="nv">relativeOutDirPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The relative base of our source file (no extension)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">relativeBase: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The MIME content-type for the source file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">contentType: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The MIME content-type for the out file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">outContentType: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The date object for when this document was created</p></div></div><div class="code"><div class="wrapper">    <span class="nv">ctime: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The date object for when this document was last modified</p></div></div><div class="code"><div class="wrapper">    <span class="nv">mtime: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Does the file actually exist on the file system</p></div></div><div class="code"><div class="wrapper">    <span class="nv">exists: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Content variables</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The encoding of the file</p></div></div><div class="code"><div class="wrapper">    <span class="nv">encoding: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The raw contents of the file, stored as a String</p></div></div><div class="code"><div class="wrapper">    <span class="nv">source: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The contents of the file, stored as a String</p></div></div><div class="code"><div class="wrapper">    <span class="nv">content: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>User set variables</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The title for this document
Useful for page headings</p></div></div><div class="code"><div class="wrapper">    <span class="nv">title: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The name for this document, defaults to the filename
Useful for navigation listings</p></div></div><div class="code"><div class="wrapper">    <span class="nv">name: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The date object for this document, defaults to mtime</p></div></div><div class="code"><div class="wrapper">    <span class="nv">date: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The generated slug (url safe seo title) for this document</p></div></div><div class="code"><div class="wrapper">    <span class="nv">slug: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The url for this document</p></div></div><div class="code"><div class="wrapper">    <span class="nv">url: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alternative urls for this document</p></div></div><div class="code"><div class="wrapper">    <span class="nv">urls: </span><span class="kc">null</span>  <span class="c1"># Array</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Whether or not we ignore this document (do not render it)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">ignored: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Whether or not we should treat this file as standalone (that nothing depends on it)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">standalone: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Helpers</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set Data</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setData: </span><span class="nf">(data) -&gt;</span>
    <span class="vi">@data = </span><span class="nx">data</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Data</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getData: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@data</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set Buffer</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setBuffer: </span><span class="nf">(buffer) -&gt;</span>
    <span class="vi">@buffer = </span><span class="nx">buffer</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Buffer</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getBuffer: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@buffer</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set Stat</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setStat: </span><span class="nf">(stat) -&gt;</span>
    <span class="vi">@stat = </span><span class="nx">stat</span>
    <span class="nx">@set</span><span class="p">(</span>
      <span class="nv">ctime: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">ctime</span><span class="p">)</span>
      <span class="nv">mtime: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Stat</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getStat: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@stat</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Attributes</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getAttributes: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@toJSON</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Meta</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getMeta: </span><span class="nf">-&gt;</span>
    <span class="vi">@meta = </span><span class="k">new</span> <span class="nx">Model</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">@meta</span> <span class="o">is</span> <span class="kc">null</span>
    <span class="k">return</span> <span class="nx">@meta</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set Meta</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setMeta: </span><span class="nf">(attrs) -&gt;</span>
    <span class="nx">@getMeta</span><span class="p">().</span><span class="nx">set</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
    <span class="nx">@set</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set Meta Defaults</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setMetaDefaults: </span><span class="nf">(defaults) -&gt;</span>
    <span class="nx">@getMeta</span><span class="p">().</span><span class="nx">setDefaults</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span>
    <span class="nx">@setDefaults</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Content</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getContent: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@getBuffer</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Out Content</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getOutContent: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@getContent</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Is Text?</p></div></div><div class="code"><div class="wrapper">  <span class="nv">isText: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="s">&#39;binary&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Is Binary?</p></div></div><div class="code"><div class="wrapper">  <span class="nv">isBinary: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;binary&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the url for the file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setUrl: </span><span class="nf">(url) -&gt;</span>
    <span class="nx">@addUrl</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="nx">@set</span><span class="p">({</span><span class="nx">url</span><span class="p">})</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add a url
Allows our file to support multiple urls</p></div></div><div class="code"><div class="wrapper">  <span class="nv">addUrl: </span><span class="nf">(url) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Multiple Urls</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">url</span> <span class="k">instanceof</span> <span class="nb">Array</span>
      <span class="k">for</span> <span class="nx">newUrl</span> <span class="k">in</span> <span class="nx">url</span>
        <span class="nx">@addUrl</span><span class="p">(</span><span class="nx">newUrl</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Single Url</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span> <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">found = </span><span class="kc">false</span>
      <span class="nv">urls = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;urls&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="k">own</span> <span class="nx">existingUrl</span> <span class="k">in</span> <span class="nx">urls</span>
        <span class="k">if</span> <span class="nx">existingUrl</span> <span class="o">is</span> <span class="nx">url</span>
          <span class="nv">found = </span><span class="kc">true</span>
          <span class="k">break</span>
      <span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>  <span class="k">if</span> <span class="o">not</span> <span class="nx">found</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove a url
Removes a url from our file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">removeUrl: </span><span class="nf">(userUrl) -&gt;</span>
    <span class="nv">urls = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;urls&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">url</span><span class="p">,</span><span class="nx">index</span> <span class="k">in</span> <span class="nx">urls</span>
      <span class="k">if</span> <span class="nx">url</span> <span class="o">is</span> <span class="nx">userUrl</span>
        <span class="nx">urls</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a Path
If the path starts with <code>.</code> then we get the path in relation to the document that is calling it
Otherwise we just return it as normal</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getPath: </span><span class="nf">(relativePath, parentPath) -&gt;</span>
    <span class="k">if</span> <span class="sr">/^\./</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">)</span>
      <span class="nv">relativeDirPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;relativeDirPath&#39;</span><span class="p">)</span>
      <span class="nv">path = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">relativeDirPath</span><span class="p">,</span> <span class="nx">relativePath</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">parentPath</span>
        <span class="nv">path = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">parentPath</span><span class="p">,</span> <span class="nx">relativePath</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">path = </span><span class="nx">relativePath</span>
    <span class="k">return</span> <span class="nx">path</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Actions</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initialize</p></div></div><div class="code"><div class="wrapper">  <span class="nv">initialize: </span><span class="nf">(attrs,opts) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">outDirPath</span><span class="p">,</span><span class="nx">stat</span><span class="p">,</span><span class="nx">data</span><span class="p">,</span><span class="nx">meta</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Special</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@outDirPath = </span><span class="nx">outDirPath</span>  <span class="k">if</span> <span class="nx">outDirPath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Defaults</p></div></div><div class="code"><div class="wrapper">    <span class="nv">defaults =</span>
      <span class="nv">extensions: </span><span class="p">[]</span>
      <span class="nv">urls: </span><span class="p">[]</span>
      <span class="nv">id: </span><span class="nx">@cid</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stat</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">stat</span>
      <span class="nx">@setStat</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">defaults.ctime = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="nv">defaults.mtime = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Defaults</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@set</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Data</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span>
      <span class="nv">data = </span><span class="nx">attrs</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">delete</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">delete</span> <span class="nx">@attributes</span><span class="p">.</span><span class="nx">data</span>
    <span class="k">if</span> <span class="nx">data</span>
      <span class="nx">@setData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Meta</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">meta</span><span class="o">?</span>
      <span class="nx">@setMeta</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">meta</span><span class="p">)</span>
      <span class="k">delete</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">meta</span>
    <span class="k">if</span> <span class="nx">meta</span>
      <span class="nx">@setMeta</span><span class="p">(</span><span class="nx">meta</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Super</p></div></div><div class="code"><div class="wrapper">    <span class="k">super</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the arguments for the action
Using this contains the transparency with using opts, and not using opts</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getActionArgs: </span><span class="nf">(opts,next) -&gt;</span>
    <span class="k">if</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="o">and</span> <span class="nx">next</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nv">next = </span><span class="nx">opts</span>
      <span class="nv">opts = </span><span class="p">{}</span>
    <span class="k">else</span>
      <span class="nx">opts</span> <span class="o">or=</span> <span class="p">{}</span>
    <span class="nx">next</span> <span class="o">or=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">next</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">next</span><span class="p">,</span><span class="nx">opts</span><span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load
If the fullPath exists, load the file
If it doesn't, then parse and normalize the file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">load: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">exists = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">exists</span> <span class="o">?</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Normalize</p></div></div><div class="code"><div class="wrapper">    <span class="nv">fullPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span>
    <span class="k">unless</span> <span class="nx">fullPath</span>
      <span class="nv">filePath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;relativePath&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@get</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">)</span>
      <span class="nv">fullPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">filePath</span> <span class="o">or</span> <span class="kc">null</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">fullPath</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Loading the file: </span><span class="si">#{</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) =&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Loaded the file: </span><span class="si">#{</span><span class="nx">fullPath</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">parse</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">normalize</span> <span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">file</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If data is set, use that as the buffer</p></div></div><div class="code"><div class="wrapper">    <span class="nv">data = </span><span class="nx">file</span><span class="p">.</span><span class="nx">getData</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">data</span>
      <span class="nv">buffer = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">setBuffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If stat is set, use that</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">stat</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">setStat</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">stat</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If buffer is set, use that</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">buffer</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">setBuffer</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stat the file and cache the result</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise fetch new stat</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">fullPath</span> <span class="o">and</span> <span class="nx">exists</span> <span class="o">and</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">stat</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">fullPath</span><span class="p">,</span> <span class="nf">(err,fileStat) -&gt;</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">file</span><span class="p">.</span><span class="nx">setStat</span><span class="p">(</span><span class="nx">fileStat</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read the file and cache the result</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise fetch new buffer</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">fullPath</span> <span class="o">and</span> <span class="nx">exists</span> <span class="o">and</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">buffer</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">fullPath</span><span class="p">,</span> <span class="nf">(err,buffer) -&gt;</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">file</span><span class="p">.</span><span class="nx">setBuffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run the tasks</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">fullPath</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">fullPath</span><span class="p">,</span> <span class="nf">(_exists) -&gt;</span>
        <span class="nv">exists = </span><span class="nx">_exists</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">exists</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
        <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse
Parse our buffer and extract meaningful data from it
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parse: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">buffer = </span><span class="nx">@getBuffer</span><span class="p">()</span>
    <span class="nv">fullPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span>
    <span class="nv">encoding = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Detect encoding</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">encoding</span>
      <span class="nv">isText = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">isTextSync</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">,</span><span class="nx">buffer</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">isText</span>
        <span class="nv">encoding = </span><span class="s">&#39;utf8&#39;</span>
      <span class="k">else</span>
        <span class="nv">encoding = </span><span class="s">&#39;binary&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch source with encoding</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">encoding</span> <span class="o">is</span> <span class="s">&#39;utf8&#39;</span>
      <span class="nv">source = </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">encoding</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">source = </span><span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Trim the content</p></div></div><div class="code"><div class="wrapper">    <span class="nv">content = </span><span class="nx">source</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n?/gm</span><span class="p">,</span><span class="s">&#39;\n&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t/g</span><span class="p">,</span><span class="s">&#39;    &#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@set</span><span class="p">({</span><span class="nx">source</span><span class="p">,</span><span class="nx">content</span><span class="p">,</span><span class="nx">encoding</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">    <span class="nx">next</span><span class="p">()</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Normalize data
Normalize any parsing we have done, as if a value has updates it may have consequences on another value. This will ensure everything is okay.
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">normalize: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">changes = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch</p></div></div><div class="code"><div class="wrapper">    <span class="nv">meta = </span><span class="nx">@getMeta</span><span class="p">()</span>
    <span class="nv">basename = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;basename&#39;</span><span class="p">)</span>
    <span class="nv">filename = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">)</span>
    <span class="nv">fullPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;fullPath&#39;</span><span class="p">)</span>
    <span class="nv">extensions = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;extensions&#39;</span><span class="p">)</span>
    <span class="nv">relativePath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;relativePath&#39;</span><span class="p">)</span>
    <span class="nv">mtime = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;mtime&#39;</span><span class="p">)</span>
    <span class="nv">date = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Filename</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">fullPath</span>
      <span class="nv">changes.filename = filename = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">)</span>
      <span class="nv">changes.outFilename = </span><span class="nx">filename</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Basename, extensions, extension</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">filename</span>
      <span class="k">if</span> <span class="nx">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;.&#39;</span>
        <span class="nv">basename = </span><span class="nx">filename</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\.[^\.]+)\..*$/</span><span class="p">,</span> <span class="s">&#39;$1&#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">basename = </span><span class="nx">filename</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\..*$/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="nv">changes.basename = </span><span class="nx">basename</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extensions</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">extensions</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span> <span class="o">or</span> <span class="nx">extensions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nv">extensions = </span><span class="nx">filename</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\./g</span><span class="p">)</span>
        <span class="nx">extensions</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="c1"># ignore the first result, as that is our filename</span>
      <span class="nv">changes.extensions = </span><span class="nx">extensions</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>determine the single extension that determine this file</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">extensions</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">extension = </span><span class="nx">extensions</span><span class="p">[</span><span class="nx">extensions</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nv">extension = </span><span class="kc">null</span>
      <span class="nv">changes.extension = </span><span class="nx">extension</span>
      <span class="nv">changes.outExtension = </span><span class="nx">extension</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>fullDirPath, contentType</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">fullPath</span>
      <span class="nv">changes.fullDirPath = fullDirPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">)</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
      <span class="nv">changes.contentType = contentType = </span><span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">)</span>
      <span class="nv">changes.outContentType = </span><span class="nx">contentType</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>relativeDirPath, relativeBase</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">relativePath</span>
      <span class="nv">changes.relativeDirPath = relativeDirPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\.$/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
      <span class="nv">changes.relativeBase = relativeBase =</span>
        <span class="k">if</span> <span class="nx">relativeDirPath</span>
          <span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">relativeDirPath</span><span class="p">,</span> <span class="nx">basename</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">basename</span>
      <span class="nv">changes.id = id = </span><span class="nx">relativePath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Date</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">!</span><span class="nx">date</span> <span class="o">and</span> <span class="nx">mtime</span>
      <span class="nv">changes.date = date = </span><span class="nx">mtime</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@set</span><span class="p">(</span><span class="nx">changes</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">    <span class="nx">next</span><span class="p">()</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Contextualize data
Put our data into perspective of the bigger picture. For instance, generate the url for it's rendered equivalant.
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">contextualize: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@getActionArgs</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">changes = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch</p></div></div><div class="code"><div class="wrapper">    <span class="nv">meta = </span><span class="nx">@getMeta</span><span class="p">()</span>
    <span class="nv">relativePath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;relativePath&#39;</span><span class="p">)</span>
    <span class="nv">relativeDirPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;relativeDirPath&#39;</span><span class="p">)</span>
    <span class="nv">relativeBase = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;relativeBase&#39;</span><span class="p">)</span>
    <span class="nv">filename = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">)</span>
    <span class="nv">outPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;outPath&#39;</span><span class="p">)</span>
    <span class="nv">outDirPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;outDirPath&#39;</span><span class="p">)</span>
    <span class="nv">name = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="nv">slug = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;slug&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="nv">url = </span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the URL for the file</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">!</span><span class="nx">url</span> <span class="o">and</span> <span class="nx">relativePath</span>
      <span class="nv">url = </span><span class="s">&quot;/</span><span class="si">#{</span><span class="nx">relativePath</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">@setUrl</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a slug for the file</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">!</span><span class="nx">slug</span> <span class="o">and</span> <span class="nx">relativeBase</span>
      <span class="nv">changes.slug = slug = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">generateSlugSync</span><span class="p">(</span><span class="nx">relativeBase</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set name if it doesn't exist already</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">!</span><span class="nx">name</span> <span class="o">and</span> <span class="nx">filename</span>
      <span class="nv">changes.name = name = </span><span class="nx">filename</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the outPath if we have a outpute directory</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@outDirPath</span> <span class="o">and</span> <span class="nx">relativePath</span>
      <span class="nv">changes.relativeOutDirPath = relativeOutDirPath = </span><span class="nx">relativeDirPath</span>  <span class="k">if</span>  <span class="nx">relativeDirPath</span><span class="o">?</span>
      <span class="nv">changes.relativeOutPath = relativeOutPath = </span><span class="nx">relativePath</span>
      <span class="nv">changes.outPath = outPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@outDirPath</span><span class="p">,</span><span class="nx">relativePath</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">outPath</span>
        <span class="nv">changes.outDirPath = outDirPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">outPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@set</span><span class="p">(</span><span class="nx">changes</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">    <span class="nx">next</span><span class="p">()</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>CRUD</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write the rendered file
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">write: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">fileOutPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;outPath&#39;</span><span class="p">)</span>
    <span class="nv">encoding = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span>
    <span class="nv">content = </span><span class="nx">@getContent</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check
Sometimes the out path could not be set if we are early on in the process</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">fileOutPath</span>
      <span class="nx">next</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Writing the file: </span><span class="si">#{</span><span class="nx">fileOutPath</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">encoding</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write data</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">fileOutPath</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Wrote the file: </span><span class="si">#{</span><span class="nx">fileOutPath</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">encoding</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">      <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Delete the file
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="k">delete</span><span class="o">:</span> <span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="nx">@</span>
    <span class="nv">fileOutPath = </span><span class="nx">@get</span><span class="p">(</span><span class="s">&#39;outPath&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check
Sometimes the out path could not be set if we are early on in the process</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">fileOutPath</span>
      <span class="nx">next</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Delete the file: </span><span class="si">#{</span><span class="nx">fileOutPath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check existance</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">fileOutPath</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Exit if it doesn't exist</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>  <span class="k">unless</span> <span class="nx">exists</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If it does exist delete it</p></div></div><div class="code"><div class="wrapper">      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">unlink</span> <span class="nx">fileOutPath</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">        <span class="nx">file</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="s">&quot;Deleted the file: </span><span class="si">#{</span><span class="nx">fileOutPath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">        <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Export</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports = </span><span class="nx">FileModel</span></div></div></div></div></body></html>