<!DOCTYPE html><html lang="en"><head><title>src/lib/plugin-loader</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/lib/plugin-loader"><meta name="groc-project-path" content="src/lib/plugin-loader.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/lib/plugin-loader.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p>Requires</p></div></div><div class="code"><div class="wrapper"><span class="nv">pathUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
<span class="nv">semver = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;semver&#39;</span><span class="p">)</span>
<span class="nv">balUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;bal-util&#39;</span><span class="p">)</span>
<span class="nv">util = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;util&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Define Plugin Loader</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">PluginLoader</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Constructed</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad Instance</p></div></div><div class="code"><div class="wrapper">  <span class="nv">docpad: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>BasePlugin Class</p></div></div><div class="code"><div class="wrapper">  <span class="nv">BasePlugin: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The full path of the plugin's directory</p></div></div><div class="code"><div class="wrapper">  <span class="nv">dirPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Loaded</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The full path of the plugin's package.json file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">packagePath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The parsed contents of the plugin's package.json file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">packageData: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The full path of the plugin's main file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">pluginPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The parsed content of the plugin's main file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">pluginClass: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugin name</p></div></div><div class="code"><div class="wrapper">  <span class="nv">pluginName: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugin version</p></div></div><div class="code"><div class="wrapper">  <span class="nv">pluginVersion: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Node modules path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">nodeModulesPath: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Functions</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Constructor</p></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">({@docpad,@dirPath,@BasePlugin}) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@docpad</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@pluginName = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">@dirPath</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^docpad-plugin-/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="vi">@pluginClass = </span><span class="p">{}</span>
    <span class="vi">@packageData = </span><span class="p">{}</span>
    <span class="vi">@nodeModulesPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@dirPath</span><span class="p">,</span> <span class="s">&#39;node_modules&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Exists
Loads in the plugin either via a package.json file, or a guessing based on the name
next(err,exists)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">exists: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Package.json</p></div></div><div class="code"><div class="wrapper">    <span class="nv">packagePath = </span><span class="nx">@packagePath</span> <span class="o">or</span> <span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@dirPath</span><span class="p">,</span> <span class="s">&quot;package.json&quot;</span><span class="p">)</span>
    <span class="nv">pluginPath = </span><span class="nx">@pluginPath</span> <span class="o">or</span> <span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@dirPath</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@pluginName</span><span class="si">}</span><span class="s">.plugin.coffee&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the fetch of the this value above allows advanced use cases of plugin loading
hover, as of yet, we don't do any such advanced use cases</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">packagePath</span><span class="p">,</span> <span class="nf">(exists) =&gt;</span>
      <span class="k">unless</span> <span class="nx">exists</span>
        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">pluginPath</span><span class="p">,</span> <span class="nf">(exists) =&gt;</span>
          <span class="k">unless</span> <span class="nx">exists</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="vi">@pluginPath = </span><span class="nx">pluginPath</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="vi">@packagePath = </span><span class="nx">packagePath</span>
        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">packagePath</span><span class="p">,</span> <span class="nf">(err,data) =&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="k">try</span>
              <span class="vi">@packageData = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
            <span class="k">catch</span> <span class="nx">err</span>
              <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">@packageData</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch the plugin path</p></div></div><div class="code"><div class="wrapper">            <span class="nv">pluginPath = </span><span class="nx">@packageData</span><span class="p">.</span><span class="nx">main</span><span class="o">?</span> <span class="o">and</span> <span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@dirPath</span><span class="p">,</span> <span class="nx">@pluginPath</span><span class="p">)</span> <span class="o">or</span> <span class="nx">pluginPath</span>
            <span class="vi">@pluginVersion = </span><span class="nx">@packageData</span><span class="p">.</span><span class="nx">version</span>
            <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">pluginPath</span><span class="p">,</span> <span class="nf">(exists) =&gt;</span>
              <span class="k">unless</span> <span class="nx">exists</span>
                <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>
              <span class="k">else</span>
                <span class="vi">@pluginPath = </span><span class="nx">pluginPath</span>
                <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Unsupported
Check if this plugin is unsupported
next(err,supported)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">unsupported: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@docpad</span>
    <span class="nv">unsupported = </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check type</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@packageData</span>
      <span class="nv">keywords = </span><span class="nx">@packageData</span><span class="p">.</span><span class="nx">keywords</span> <span class="o">or</span> <span class="p">[]</span>
      <span class="k">unless</span> <span class="s">&#39;docpad-plugin&#39;</span> <span class="k">in</span> <span class="nx">keywords</span>
        <span class="nv">unsupported = </span><span class="s">&#39;type&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check platform</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@packageData</span> <span class="o">and</span> <span class="nx">@packageData</span><span class="p">.</span><span class="nx">platforms</span>
      <span class="nv">platforms = </span><span class="nx">@packageData</span><span class="p">.</span><span class="nx">platforms</span> <span class="o">or</span> <span class="p">[]</span>
      <span class="k">unless</span> <span class="nx">process</span><span class="p">.</span><span class="nx">platform</span> <span class="k">in</span> <span class="nx">platforms</span>
        <span class="nv">unsupported = </span><span class="s">&#39;platform&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check engines</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@packageData</span> <span class="o">and</span> <span class="nx">@packageData</span><span class="p">.</span><span class="nx">engines</span>
      <span class="nv">engines = </span><span class="nx">@packageData</span><span class="p">.</span><span class="nx">engines</span> <span class="o">or</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Node engine</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">engines</span><span class="p">.</span><span class="nx">node</span><span class="o">?</span>
        <span class="k">unless</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">satisfies</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">engines</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span>
          <span class="nv">unsupported = </span><span class="s">&#39;engine&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad engine</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">engines</span><span class="p">.</span><span class="nx">docpad</span><span class="o">?</span>
        <span class="k">unless</span> <span class="nx">semver</span><span class="p">.</span><span class="nx">satisfies</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">engines</span><span class="p">.</span><span class="nx">docpad</span><span class="p">)</span>
          <span class="nv">unsupported = </span><span class="s">&#39;version&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Supported</p></div></div><div class="code"><div class="wrapper">    <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">unsupported</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install
Installs the plugins node modules
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">install: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@docpad</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Only install if we have a package path</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@packagePath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install npm modules</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">initNodeModules</span><span class="p">(</span>
        <span class="nv">path: </span><span class="nx">@dirPath</span>
        <span class="nv">next: </span><span class="nf">(err,results) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Continue</p></div></div><div class="code"><div class="wrapper">      <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load
Load in the pluginClass from the pugin file
next(err,pluginClass)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">load: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@docpad</span>
    <span class="nv">locale = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load</p></div></div><div class="code"><div class="wrapper">    <span class="k">try</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load in our plugin</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@pluginClass = </span><span class="nx">require</span><span class="p">(</span><span class="nx">@pluginPath</span><span class="p">)(</span><span class="nx">@BasePlugin</span><span class="p">)</span>
      <span class="nx">@pluginClass</span><span class="o">::</span><span class="nx">version</span> <span class="o">?=</span> <span class="nx">@pluginVersion</span>
      <span class="nv">pluginPrototypeName = </span><span class="nx">@pluginClass</span><span class="o">::</span><span class="nx">name</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Checks
Alphanumeric</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="sr">/^[a-z0-9]+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">@pluginName</span><span class="p">)</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="nv">validPluginName = </span><span class="nx">@pluginName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^a-z0-9]/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginNamingConventionInvalid</span><span class="p">,</span> <span class="nx">@pluginName</span><span class="p">,</span> <span class="nx">validPluginName</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Same name</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">pluginPrototypeName</span> <span class="o">is</span> <span class="kc">null</span>
        <span class="vi">@pluginClass::name = </span><span class="nx">@pluginName</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span>  <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginPrototypeNameUndefined</span><span class="p">,</span> <span class="nx">@pluginName</span><span class="p">))</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">pluginPrototypeName</span> <span class="o">isnt</span> <span class="nx">@pluginName</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginPrototypeNameDifferent</span><span class="p">,</span> <span class="nx">@pluginName</span><span class="p">,</span> <span class="nx">pluginPrototypeName</span><span class="p">))</span>
    <span class="k">catch</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>An error occured, return it</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return our plugin</p></div></div><div class="code"><div class="wrapper">    <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">@pluginClass</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create Instance
next(err,pluginInstance)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">create: </span><span class="nf">(userConfiguration={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load</p></div></div><div class="code"><div class="wrapper">    <span class="k">try</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Merge configurations</p></div></div><div class="code"><div class="wrapper">      <span class="nv">config = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">deepExtendPlainObjects</span><span class="p">({},</span> <span class="nx">@docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">plugins</span><span class="p">[</span><span class="nx">@pluginName</span><span class="p">],</span> <span class="nx">userConfiguration</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create instance with merged configuration</p></div></div><div class="code"><div class="wrapper">      <span class="nv">docpad = </span><span class="nx">@docpad</span>
      <span class="nv">pluginInstance = </span><span class="k">new</span> <span class="nx">@pluginClass</span><span class="p">({</span><span class="nx">docpad</span><span class="p">,</span><span class="nx">config</span><span class="p">})</span>
    <span class="k">catch</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>An error occured, return it</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return our instance</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">pluginInstance</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Export</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports = </span><span class="nx">PluginLoader</span></div></div></div></div></body></html>