<!DOCTYPE html><html lang="en"><head><title>src/lib/docpad</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/lib/docpad"><meta name="groc-project-path" content="src/lib/docpad.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/lib/docpad.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="dependency-tree">Dependency tree</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The DocPad program, for a large amount at least, inherits and builds upon
functionality that is an extension of either node.js core modules, or external
packages to bring additional models inside our current instance context.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="node-core-modules">Node core modules</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="pathhttpnodejsorgapipathhtml"><a href="http://nodejs.org/api/path.html">Path</a></h3>

<p>This module contains utilities for handling and transforming file paths.
Almost all these methods perform only string transformations. The file system
is not consulted to check whether paths are valid.</p></div></div><div class="code"><div class="wrapper"><span class="nv">pathUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="utilitieshttpnodejsorgapiutilhtml"><a href="http://nodejs.org/api/util.html">Utilities</a></h3>

<p>Import the core module utilities so we may easily work with debugging, type
checking and logging facilities as well as provide the mean to perform
polymorpism my the <code>utils.inherits</code> method.</p></div></div><div class="code"><div class="wrapper"><span class="nv">util = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;util&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="vendor-bevry">Vendor: Bevry</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>CoffeeScript Object Notation or CSON. It will allow for conversion from JSON
to CSON and vice versa. Use it from the command line <code>./node_modules/.bin</code> or
add that path to your <code>$PATH</code> <a href="http://en.wikipedia.org/wiki/PATH_(variable)">system environment
variable</a>.</p></div></div><div class="code"><div class="wrapper"><span class="nv">CSON = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;cson&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Balupton's Utilities are some essential helper functionalities which aren't
found in the core node.js modules. Enhanced events, better control flow,
module helpers, file-path or URL resolution plus extra types to check. This is
the Bevry swiss army knife.</p></div></div><div class="code"><div class="wrapper"><span class="nv">balUtil = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;bal-util&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Smple, intuitive console logger from Bevry. Supports grouping of messages,
filtering log levels, colors, times, modules, custom formatters and custom
transports.</p></div></div><div class="code"><div class="wrapper"><span class="nv">caterpillar = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;caterpillar&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="third-party-modules">Third party modules</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Underscore provides 80-odd functions that support both the usual functional
suspects: map, select, invoke â€” as well as more specialized helpers</p></div></div><div class="code"><div class="wrapper"><span class="nv">_ = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;underscore&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="domain-instanciated-objects">Domain instanciated objects</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a instance based on the general utility-belt <code>balUtil</code></p></div></div><div class="code"><div class="wrapper"><span class="p">{</span><span class="nx">EventEmitterEnhanced</span><span class="p">}</span> <span class="o">=</span> <span class="nx">balUtil</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create object instance variables of some of the most basic types we know, base
entities of <code>QueryEngine</code> which derives from <code>Backbone</code>, then a series of
DocPad internal (abstract) class instances of <code>Model</code>, <code>View</code>, <code>Collections</code> and
<code>Events</code>.
Finally, we provide a <code>QueryCollection</code> object for easy data retrieval.</p></div></div><div class="code"><div class="wrapper"><span class="p">{</span><span class="nx">queryEngine</span><span class="p">,</span><span class="nx">Backbone</span><span class="p">,</span><span class="nx">Events</span><span class="p">,</span><span class="nx">Model</span><span class="p">,</span><span class="nx">Collection</span><span class="p">,</span><span class="nx">View</span><span class="p">,</span><span class="nx">QueryCollection</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/base&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad currently has two (2) models defined:
* FileModel and
* DocumentModel</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>There has been some experimentation with a slightly different model which
would omit for the FileModel, but there we some name resolution conflicts and
thus currently remains unchanged here.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Derives from the <code>Model</code> super-type and contains many properties to store file
information in it's key / value pairs.</p></div></div><div class="code"><div class="wrapper"><span class="nv">FileModel = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/models/file&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Documents are actually also just files, but with some extra attention for
rendering and the option to store meta-data in its headers.</p></div></div><div class="code"><div class="wrapper"><span class="nv">DocumentModel = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/models/document&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Code import of all modules that sit in the <code>collections/</code> directory.</p></div></div><div class="code"><div class="wrapper"><span class="nv">FilesCollection = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/collections/files&#39;</span><span class="p">)</span>
<span class="nv">ElementsCollection = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/collections/elements&#39;</span><span class="p">)</span>
<span class="nv">MetaCollection = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/collections/meta&#39;</span><span class="p">)</span>
<span class="nv">ScriptsCollection = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/collections/scripts&#39;</span><span class="p">)</span>
<span class="nv">StylesCollection = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/collections/styles&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugin loader module, this could essentially be static</p></div></div><div class="code"><div class="wrapper"><span class="nv">PluginLoader = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/plugin-loader&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The abstract type representation to derive plugins from</p></div></div><div class="code"><div class="wrapper"><span class="nv">BasePlugin = </span><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/plugin&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prototypes of array, string and date being altered for better default values
or additional properties and methods available to all derived instances.</p></div></div><div class="code"><div class="wrapper"><span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span><span class="o">+</span><span class="s">&#39;/prototypes&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="the-docpad-class">The DocPad Class</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It extends the EventSystem from bal-util to provide system events.
It allows us to support multiple instances of docpad at the same time.</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">DocPad</span> <span class="k">extends</span> <span class="nx">EventEmitterEnhanced</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="local-member-variables">Local member variables</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Basic building blocks of our event-driven MVQC architecture</p></div></div><div class="code"><div class="wrapper">  <span class="nv">Events: </span><span class="nx">Events</span>
  <span class="nv">Model: </span><span class="nx">Model</span>
  <span class="nv">Collection: </span><span class="nx">Collection</span>
  <span class="nv">View: </span><span class="nx">View</span>
  <span class="nv">QueryCollection: </span><span class="nx">QueryCollection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Locally, we carry along the models of file and document data.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">FileModel: </span><span class="nx">FileModel</span>
  <span class="nv">DocumentModel: </span><span class="nx">DocumentModel</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Internal lists and collections of essential document blocks.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">FilesCollection: </span><span class="nx">FilesCollection</span>
  <span class="nv">ElementsCollection: </span><span class="nx">ElementsCollection</span>
  <span class="nv">MetaCollection: </span><span class="nx">MetaCollection</span>
  <span class="nv">ScriptsCollection: </span><span class="nx">ScriptsCollection</span>
  <span class="nv">StylesCollection: </span><span class="nx">StylesCollection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugins can rely upon the <code>PluginLoader</code> to exist</p></div></div><div class="code"><div class="wrapper">  <span class="nv">PluginLoader: </span><span class="nx">PluginLoader</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>and load the <code>BasePlugin</code></p></div></div><div class="code"><div class="wrapper">  <span class="nv">BasePlugin: </span><span class="nx">BasePlugin</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="application-instances">Application instances</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="growl">Growl</h3>

<p>Growl offers you complete control over which notifications are shown and how
they are displayed.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">growlInstance: </span><span class="kc">null</span>
  <span class="nv">getGrowlInstance: </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we don't have any Growl instance running, we pull in its configuration
and try to install the node package.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@growlInstance</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="k">if</span> <span class="nx">@getConfig</span><span class="p">().</span><span class="nx">growl</span>
        <span class="k">try</span>
          <span class="vi">@growlInstance = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;growl&#39;</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">err</span>
          <span class="vi">@growlInstance = </span><span class="kc">false</span>
      <span class="k">else</span>
        <span class="vi">@growlInstance = </span><span class="kc">false</span>

    <span class="k">return</span> <span class="nx">@growlInstance</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="mixpanelhttpsgithubcomcarlsverremixpanelnode"><a href="https://github.com/carlsverre/mixpanel-node">Mixpanel</a></h3>

<p>Mixpanel is a real-time analytics service that helps companies understand
how users interact with web applications.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">mixpanelInstance: </span><span class="kc">null</span>
  <span class="nv">getMixpanelInstance: </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we don't have any instance of Mixpanel we can use</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@mixpanelIsntance</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch configuration settings</p></div></div><div class="code"><div class="wrapper">      <span class="nv">config = </span><span class="nx">@getConfig</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set instances of report statistics and tokens to config.</p></div></div><div class="code"><div class="wrapper">      <span class="p">{</span><span class="nx">reportStatistics</span><span class="p">,</span><span class="nx">mixpanelToken</span><span class="p">}</span> <span class="o">=</span> <span class="nx">config</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we have reports or tokens to process</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">reportStatistics</span> <span class="o">and</span> <span class="nx">mixpanelToken</span>
        <span class="k">try</span>
          <span class="vi">@mixpanelInstance = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;mixpanel&#39;</span><span class="p">).</span><span class="nx">init</span><span class="p">(</span><span class="nx">mixpanelToken</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">err</span>
          <span class="vi">@mixpanelInstance = </span><span class="kc">false</span>
      <span class="k">else</span>
        <span class="vi">@mixpanelInstance = </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@mixpanelInstance</span>

  <span class="c1">## Airbrake</span>
  <span class="nv">airbrakeInstance: </span><span class="kc">null</span>
  <span class="nv">getAirbrakeInstance: </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@airbrakeInstance</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nv">config = </span><span class="nx">@getConfig</span><span class="p">()</span>
      <span class="p">{</span><span class="nx">airbrakeToken</span><span class="p">,</span><span class="nx">reportErrors</span><span class="p">}</span> <span class="o">=</span> <span class="nx">config</span>
      <span class="k">if</span> <span class="nx">reportErrors</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">and</span> <span class="sr">/win/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">platform</span><span class="p">)</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="k">try</span>
          <span class="vi">@airbrakeInstance = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;airbrake&#39;</span><span class="p">).</span><span class="nx">createClientairbrakeToken</span><span class="p">()</span>
        <span class="k">catch</span> <span class="nx">err</span>
          <span class="vi">@airbrakeInstance = </span><span class="kc">false</span>
      <span class="k">else</span>
        <span class="vi">@airbrakeInstance = </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@airbrakeInstance</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>DocPad</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad's version number</p></div></div><div class="code"><div class="wrapper">  <span class="nv">version: </span><span class="kc">null</span>
  <span class="nv">getVersion: </span><span class="nf">-&gt;</span>
    <span class="nx">@version</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The express and http server instances bound to docpad</p></div></div><div class="code"><div class="wrapper">  <span class="nv">serverExpress: </span><span class="kc">null</span>
  <span class="nv">serverHttp: </span><span class="kc">null</span>
  <span class="nv">getServer: </span><span class="nf">(both) -&gt;</span>
    <span class="p">{</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverHttp</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@</span>
    <span class="k">if</span> <span class="nx">both</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverHttp</span><span class="p">}</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">serverExpress</span>
  <span class="nv">setServer: </span><span class="nf">(servers) -&gt;</span>
    <span class="vi">@serverExpress = </span><span class="nx">servers</span><span class="p">.</span><span class="nx">serverExpress</span>
    <span class="vi">@serverHttp = </span><span class="nx">servers</span><span class="p">.</span><span class="nx">serverHttp</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The caterpillar instance bound to docpad</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loggerInstance: </span><span class="kc">null</span>
  <span class="nv">getLogger: </span><span class="nf">-&gt;</span>
    <span class="nx">@loggerInstance</span>
  <span class="nv">setLogger: </span><span class="nf">(value) -&gt;</span>
    <span class="vi">@loggerInstance = </span><span class="nx">value</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The action runner instance bound to docpad</p></div></div><div class="code"><div class="wrapper">  <span class="nv">actionRunnerInstance: </span><span class="kc">null</span>
  <span class="nv">getActionRunner: </span><span class="nf">-&gt;</span> <span class="nx">@actionRunnerInstance</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The error runner instance bound to docpad</p></div></div><div class="code"><div class="wrapper">  <span class="nv">errorRunnerInstance: </span><span class="kc">null</span>
  <span class="nv">getErrorRunner: </span><span class="nf">-&gt;</span> <span class="nx">@errorRunnerInstance</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The track runner instance bound to docpad</p></div></div><div class="code"><div class="wrapper">  <span class="nv">trackRunnerInstance: </span><span class="kc">null</span>
  <span class="nv">getTrackRunner: </span><span class="nf">-&gt;</span> <span class="nx">@trackRunnerInstance</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event Listing
Whenever a event is created, it must be applied here to be available to plugins and configuration files
https://github.com/bevry/docpad/wiki/Events</p></div></div><div class="code"><div class="wrapper">  <span class="nv">events: </span><span class="p">[</span>
    <span class="s">&#39;extendTemplateData&#39;</span>
    <span class="s">&#39;extendCollections&#39;</span>
    <span class="s">&#39;docpadLoaded&#39;</span>
    <span class="s">&#39;docpadReady&#39;</span>
    <span class="s">&#39;consoleSetup&#39;</span>
    <span class="s">&#39;generateBefore&#39;</span>
    <span class="s">&#39;populateCollections&#39;</span>
    <span class="s">&#39;generateAfter&#39;</span>
    <span class="s">&#39;parseBefore&#39;</span>
    <span class="s">&#39;parseAfter&#39;</span>
    <span class="s">&#39;contextualizeBefore&#39;</span>
    <span class="s">&#39;contextualizeAfter&#39;</span>
    <span class="s">&#39;renderBefore&#39;</span>
    <span class="s">&#39;render&#39;</span>
    <span class="s">&#39;renderDocument&#39;</span>
    <span class="s">&#39;renderAfter&#39;</span>
    <span class="s">&#39;writeBefore&#39;</span>
    <span class="s">&#39;writeAfter&#39;</span>
    <span class="s">&#39;serverBefore&#39;</span>
    <span class="s">&#39;serverExtend&#39;</span>
    <span class="s">&#39;serverAfter&#39;</span>
  <span class="p">]</span>
  <span class="nv">getEvents: </span><span class="nf">-&gt;</span>
    <span class="nx">@events</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Collections</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Database collection</p></div></div><div class="code"><div class="wrapper">  <span class="nv">database: </span><span class="kc">null</span>  <span class="c1"># QueryEngine Collection</span>
  <span class="nv">getDatabase: </span><span class="nf">-&gt;</span> <span class="nx">@database</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Files by URL
Used to speed up fetching</p></div></div><div class="code"><div class="wrapper">  <span class="nv">filesByUrl: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Blocks</p></div></div><div class="code"><div class="wrapper">  <span class="nv">blocks: </span><span class="kc">null</span>
  <span class="cm">### {</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A collection of meta elements</p></div></div><div class="code"><div class="wrapper"><span class="cm">    meta: null  # Elements Collection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A collection of script elements</p></div></div><div class="code"><div class="wrapper"><span class="cm">    scripts: null  # Scripts Collection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Collection of style elements</p></div></div><div class="code"><div class="wrapper"><span class="cm">    styles: null  # Styles Collection</span>
<span class="cm">  } ###</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a block</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getBlock: </span><span class="nf">(name,clone) -&gt;</span>
    <span class="nv">block = </span><span class="nx">@blocks</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">clone</span>
      <span class="nv">classname = </span><span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="o">+</span><span class="nx">name</span><span class="p">[</span><span class="mi">1</span><span class="p">..]</span><span class="o">+</span><span class="s">&#39;Collection&#39;</span>
      <span class="nv">block = </span><span class="k">new</span> <span class="nx">@</span><span class="p">[</span><span class="nx">classname</span><span class="p">](</span><span class="nx">block</span><span class="p">.</span><span class="nx">models</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">block</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set a block</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setBlock: </span><span class="nf">(name,value) -&gt;</span>
    <span class="nx">@blocks</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get blocks</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setBlocks: </span><span class="nf">(blocks) -&gt;</span>
    <span class="nx">@blocks</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set blocks</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setBlocks: </span><span class="nf">(blocks) -&gt;</span>
    <span class="k">for</span> <span class="k">own</span> <span class="nx">name</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">blocks</span>
      <span class="nx">@setBlock</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Collections</p></div></div><div class="code"><div class="wrapper">  <span class="nv">collections: </span><span class="kc">null</span>
  <span class="cm">### {</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Documents collection</p></div></div><div class="code"><div class="wrapper"><span class="cm">    documents: null  # QueryEngine Collection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Files collection</p></div></div><div class="code"><div class="wrapper"><span class="cm">    files: null  # QueryEngine Collection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Layouts collection</p></div></div><div class="code"><div class="wrapper"><span class="cm">    layouts: null  # QueryEngine Collection</span>
<span class="cm">  } ###</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a collection</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getCollection: </span><span class="nf">(name) -&gt;</span>
    <span class="nx">@collections</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set a collection</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setCollection: </span><span class="nf">(name,value) -&gt;</span>
    <span class="nx">@collections</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get collections</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getCollections: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@collections</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set collections</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setCollections: </span><span class="nf">(collections) -&gt;</span>
    <span class="k">for</span> <span class="k">own</span> <span class="nx">name</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">collections</span>
      <span class="nx">@setCollection</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Collection Helpers</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Files (will use live collections)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getFiles: </span><span class="nf">(query,sorting,paging) -&gt;</span>
    <span class="nv">key = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">query</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">})</span>
    <span class="nv">result = </span><span class="nx">@getCollection</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">unless</span> <span class="nx">result</span>
      <span class="nv">result = </span><span class="nx">@getDatabase</span><span class="p">().</span><span class="nx">findAllLive</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">)</span>
      <span class="nx">@setCollection</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get another file's model based on a relative path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getFile: </span><span class="nf">(query,sorting,paging) -&gt;</span>
    <span class="nv">result = </span><span class="nx">@getDatabase</span><span class="p">().</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Files At Path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getFilesAtPath: </span><span class="nf">(path,sorting,paging) -&gt;</span>
    <span class="nv">query = $or: </span><span class="p">[{</span><span class="nv">relativePath: $startsWith: </span><span class="nx">path</span><span class="p">},</span> <span class="p">{</span><span class="nv">fullPath: $startsWith: </span><span class="nx">path</span><span class="p">}]</span>
    <span class="nv">result = </span><span class="nx">@getFiles</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get another file's model based on a relative path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getFileAtPath: </span><span class="nf">(path,sorting,paging) -&gt;</span>
    <span class="nv">result = </span><span class="nx">@getDatabase</span><span class="p">().</span><span class="nx">fuzzyFindOne</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a file by its url</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getFileByUrl: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">result = </span><span class="nx">@getDatabase</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">@filesByUrl</span><span class="p">[</span><span class="nx">url</span><span class="p">])</span>
    <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Skeletons</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skeletons Collection</p></div></div><div class="code"><div class="wrapper">  <span class="nv">skeletonsCollection: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Skeletons
Get all the available skeletons for us and their details
next(err,skeletonsCollection)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getSkeletons: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we have cached locally</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@skeletonsCollection</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">@skeletonsCollection</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch the skeletons from the exchange</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@skeletonsCollection = </span><span class="k">new</span> <span class="nx">Collection</span><span class="p">()</span>
    <span class="vi">@skeletonsCollection.comparator = </span><span class="nx">queryEngine</span><span class="p">.</span><span class="nx">generateComparator</span><span class="p">(</span><span class="nx">position</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">@getExchange</span> <span class="nf">(err,exchange) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add options</p></div></div><div class="code"><div class="wrapper">      <span class="nv">index = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="k">own</span> <span class="nx">skeletonKey</span><span class="p">,</span><span class="nx">skeleton</span> <span class="k">of</span> <span class="nx">exchange</span><span class="p">.</span><span class="nx">skeletons</span>
        <span class="nx">skeleton</span><span class="p">.</span><span class="nx">id</span> <span class="o">?=</span> <span class="nx">skeletonKey</span>
        <span class="nx">skeleton</span><span class="p">.</span><span class="nx">name</span> <span class="o">?=</span> <span class="nx">skeletonKey</span>
        <span class="nx">skeleton</span><span class="p">.</span><span class="nx">position</span> <span class="o">?=</span> <span class="nx">index</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">skeletonsCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Model</span><span class="p">(</span><span class="nx">skeleton</span><span class="p">))</span>
        <span class="o">++</span><span class="nx">index</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add No Skeleton Option</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">skeletonsCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Model</span><span class="p">(</span>
        <span class="nv">id: </span><span class="s">&#39;none&#39;</span>
        <span class="nv">name: </span><span class="nx">locale</span><span class="p">.</span><span class="nx">skeletonNoneName</span>
        <span class="nv">description: </span><span class="nx">locale</span><span class="p">.</span><span class="nx">skeletonNoneDescription</span>
        <span class="nv">position: </span><span class="kc">Infinity</span>
      <span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return Collection</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">skeletonsCollection</span><span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Plugins</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugins that are loading really slow</p></div></div><div class="code"><div class="wrapper">  <span class="nv">slowPlugins: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loaded plugins indexed by name</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadedPlugins: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A listing of all the available extensions for DocPad</p></div></div><div class="code"><div class="wrapper">  <span class="nv">exchange: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Paths</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The DocPad directory</p></div></div><div class="code"><div class="wrapper">  <span class="nv">corePath: </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The DocPad library directory</p></div></div><div class="code"><div class="wrapper">  <span class="nv">libPath: </span><span class="nx">__dirname</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The main DocPad file</p></div></div><div class="code"><div class="wrapper">  <span class="nv">mainPath: </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;docpad&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The DocPad package.json path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">packagePath: </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;package.json&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The DocPad locale path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">localePath: </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;locale&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The User's configuration path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">userConfigPath: </span><span class="s">&#39;.docpad.cson&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Template Data</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad's Template Data</p></div></div><div class="code"><div class="wrapper">  <span class="nv">initialTemplateData: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugin's Extended Template Data</p></div></div><div class="code"><div class="wrapper">  <span class="nv">pluginsTemplateData: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Complete Template Data</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getTemplateData: </span><span class="nf">(userTemplateData) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nx">userTemplateData</span> <span class="o">or=</span> <span class="p">{}</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="p">{</span><span class="nx">renderPasses</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@config</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the initial docpad template data</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@initialTemplateData</span> <span class="o">?=</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Site Properties</p></div></div><div class="code"><div class="wrapper">      <span class="nv">site: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Environment</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getEnvironment: </span><span class="nf">-&gt;</span>
        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getEnvironment</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Environments</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getEnvironments: </span><span class="nf">-&gt;</span>
        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getEnvironments</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set that we reference other files</p></div></div><div class="code"><div class="wrapper">      <span class="nv">referencesOthers: </span><span class="nf">(flag) -&gt;</span>
        <span class="nb">document</span> <span class="o">=</span> <span class="nx">@getDocument</span><span class="p">()</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">referencesOthers</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the Document</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getDocument: </span><span class="nf">-&gt;</span>
        <span class="k">return</span> <span class="nx">@documentModel</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a Path in respect to the current document</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getPath: </span><span class="nf">(path,parentPath) -&gt;</span>
        <span class="nb">document</span> <span class="o">=</span> <span class="nx">@getDocument</span><span class="p">()</span>
        <span class="nv">path = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="nx">parentPath</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">path</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Files</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getFiles: </span><span class="nf">(query,sorting,paging) -&gt;</span>
        <span class="nx">@referencesOthers</span><span class="p">()</span>
        <span class="nv">result = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getFiles</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get another file's URL based on a relative path</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getFile: </span><span class="nf">(query,sorting,paging) -&gt;</span>
        <span class="nx">@referencesOthers</span><span class="p">()</span>
        <span class="nv">result = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getFile</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Files At Path</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getFilesAtPath: </span><span class="nf">(path,sorting,paging) -&gt;</span>
        <span class="nx">@referencesOthers</span><span class="p">()</span>
        <span class="nv">path = </span><span class="nx">@getPath</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
        <span class="nv">result = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getFilesAtPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="nx">sorting</span><span class="p">,</span><span class="nx">paging</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get another file's model based on a relative path</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getFileAtPath: </span><span class="nf">(relativePath) -&gt;</span>
        <span class="nx">@referencesOthers</span><span class="p">()</span>
        <span class="nv">path = </span><span class="nx">@getPath</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">)</span>
        <span class="nv">result = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getFileAtPath</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the entire database</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getDatabase: </span><span class="nf">-&gt;</span>
        <span class="nx">@referencesOthers</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a pre-defined collection</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getCollection: </span><span class="nf">(name) -&gt;</span>
        <span class="nx">@referencesOthers</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a block</p></div></div><div class="code"><div class="wrapper">      <span class="nv">getBlock: </span><span class="nf">(name) -&gt;</span>
        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getBlock</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Include another file taking in a relative path</p></div></div><div class="code"><div class="wrapper">      <span class="nv">include: </span><span class="nf">(subRelativePath,strict=true) -&gt;</span>
        <span class="nv">file = </span><span class="nx">@getFileAtPath</span><span class="p">(</span><span class="nx">subRelativePath</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">file</span>
          <span class="k">if</span> <span class="nx">strict</span> <span class="o">and</span> <span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;rendered&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="kc">false</span>
            <span class="k">if</span> <span class="nx">renderPasses</span> <span class="o">is</span> <span class="mi">1</span>
              <span class="nx">docpad</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderedEarlyViaInclude</span><span class="p">,</span> <span class="nx">subRelativePath</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">null</span>
          <span class="k">return</span> <span class="nx">file</span><span class="p">.</span><span class="nx">getOutContent</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">includeFailed</span><span class="p">,</span> <span class="nx">subRelativePath</span><span class="p">))</span>
          <span class="k">throw</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch our result template data</p></div></div><div class="code"><div class="wrapper">    <span class="nv">templateData = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">@initialTemplateData</span><span class="p">,</span> <span class="nx">@pluginsTemplateData</span><span class="p">,</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">templateData</span><span class="p">,</span> <span class="nx">userTemplateData</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add site data</p></div></div><div class="code"><div class="wrapper">    <span class="nx">templateData</span><span class="p">.</span><span class="nx">site</span><span class="p">.</span><span class="nx">date</span> <span class="o">or=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="nx">templateData</span><span class="p">.</span><span class="nx">site</span><span class="p">.</span><span class="nx">keywords</span> <span class="o">or=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">templateData</span><span class="p">.</span><span class="nx">site</span><span class="p">.</span><span class="nx">keywords</span><span class="p">)</span>
      <span class="nv">templateData.site.keywords = </span><span class="nx">templateData</span><span class="p">.</span><span class="nx">site</span><span class="p">.</span><span class="nx">keywords</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/,\s*/g</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return</p></div></div><div class="code"><div class="wrapper">    <span class="nx">templateData</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Locales</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>All the locales we have</p></div></div><div class="code"><div class="wrapper">  <span class="nv">locales:</span>
    <span class="nv">en: </span><span class="nx">CSON</span><span class="p">.</span><span class="nx">parseFileSync</span><span class="p">(</span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;locale&#39;</span><span class="p">,</span> <span class="s">&#39;en.cson&#39;</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determined locale</p></div></div><div class="code"><div class="wrapper">  <span class="nv">locale: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determined locale code</p></div></div><div class="code"><div class="wrapper">  <span class="nv">localeCode: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Locale Code</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getLocaleCode: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@localeCode</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nv">localeCode = </span><span class="kc">null</span>
      <span class="nv">localeCodes = </span><span class="p">[</span><span class="nx">@getConfig</span><span class="p">().</span><span class="nx">localeCode</span><span class="p">,</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LANG</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\..+/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&#39;en_AU&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">localeCode</span> <span class="k">in</span> <span class="nx">localeCodes</span>
        <span class="k">if</span> <span class="nx">localeCode</span> <span class="o">and</span> <span class="nx">@locales</span><span class="p">[</span><span class="nx">localeCode</span><span class="p">]</span><span class="o">?</span>
          <span class="k">break</span>
      <span class="vi">@localeCode = </span><span class="nx">localeCode</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">@localeCode</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Language Code</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getLanguageCode: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@languageCode</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nv">languageCode = </span><span class="nx">@getLocaleCode</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^([a-z]+)_([a-z]+)$/i</span><span class="p">,</span><span class="s">&#39;$1&#39;</span><span class="p">)</span>
      <span class="vi">@languageCode = </span><span class="nx">languageCode</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">@languageCode</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Country Code</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getCountryCode: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@countryCode</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nv">countryCode = </span><span class="nx">@getLocaleCode</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^([a-z]+)_([a-z]+)$/i</span><span class="p">,</span><span class="s">&#39;$2&#39;</span><span class="p">)</span>
      <span class="vi">@countryCode = </span><span class="nx">countryCode</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">@countryCode</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Locale</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getLocale: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@locale</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="vi">@locale = </span><span class="nx">@locales</span><span class="p">[</span><span class="nx">@getLocaleCode</span><span class="p">()]</span> <span class="o">or</span> <span class="nx">@locales</span><span class="p">[</span><span class="nx">@getLanguageCode</span><span class="p">()]</span> <span class="o">or</span> <span class="nx">@locales</span><span class="p">[</span><span class="s">&#39;en&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@locale</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Environments</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Environment</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getEnvironment: </span><span class="nf">-&gt;</span>
    <span class="nv">env = </span><span class="nx">@getConfig</span><span class="p">().</span><span class="nx">env</span> <span class="o">or</span> <span class="s">&#39;development&#39;</span>
    <span class="k">return</span> <span class="nx">env</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Environments</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getEnvironments: </span><span class="nf">-&gt;</span>
    <span class="nv">env = </span><span class="nx">@getEnvironment</span><span class="p">()</span>
    <span class="nv">envs = </span><span class="nx">env</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[, ]+/</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">envs</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Configuration</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Website Package Configuration</p></div></div><div class="code"><div class="wrapper">  <span class="nv">websitePackageConfig: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Merged Configuration
Merged in the order of:
- initialConfig
- userConfig
- websiteConfig
- instanceConfig
- environmentConfig</p></div></div><div class="code"><div class="wrapper">  <span class="nv">config: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Instance Configuration</p></div></div><div class="code"><div class="wrapper">  <span class="nv">instanceConfig: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Website Configuration</p></div></div><div class="code"><div class="wrapper">  <span class="nv">websiteConfig: </span><span class="kc">null</span>  <span class="c1"># {}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>User Configuraiton</p></div></div><div class="code"><div class="wrapper">  <span class="nv">userConfig:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Name</p></div></div><div class="code"><div class="wrapper">    <span class="nv">name: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Email</p></div></div><div class="code"><div class="wrapper">    <span class="nv">email: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Username</p></div></div><div class="code"><div class="wrapper">    <span class="nv">username: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Subscribed</p></div></div><div class="code"><div class="wrapper">    <span class="nv">subscribed: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Subcribe Try Again
If our subscription has failed, when should we try again?</p></div></div><div class="code"><div class="wrapper">    <span class="nv">subscribeTryAgain: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initial Configuration</p></div></div><div class="code"><div class="wrapper">  <span class="nv">initialConfig:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Plugins</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Force re-install of all plugin dependencies</p></div></div><div class="code"><div class="wrapper">    <span class="nv">force: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Whether or not we should enable plugins that have not been listed or not</p></div></div><div class="code"><div class="wrapper">    <span class="nv">enableUnlistedPlugins: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugins which should be enabled or not pluginName: pluginEnabled</p></div></div><div class="code"><div class="wrapper">    <span class="nv">enabledPlugins: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Whether or not we should skip unsupported plugins</p></div></div><div class="code"><div class="wrapper">    <span class="nv">skipUnsupportedPlugins: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Configuration to pass to any plugins pluginName: pluginConfiguration</p></div></div><div class="code"><div class="wrapper">    <span class="nv">plugins: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Where to fetch the exchange information from</p></div></div><div class="code"><div class="wrapper">    <span class="nv">exchangeUrl: </span><span class="s">&#39;https://docpad.org/exchange.json&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Website Paths</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website directory</p></div></div><div class="code"><div class="wrapper">    <span class="nv">rootPath: </span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's package.json path</p></div></div><div class="code"><div class="wrapper">    <span class="nv">packagePath: </span><span class="s">&#39;package.json&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Where to get the latest package information from</p></div></div><div class="code"><div class="wrapper">    <span class="nv">latestPackageUrl: </span><span class="s">&#39;https://docpad.org/latest.json&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's configuration paths
Reads only the first one that exists
If you want to read multiple configuration paths, then point it to a coffee|js file that requires
the other paths you want and exports the merged config</p></div></div><div class="code"><div class="wrapper">    <span class="nv">configPaths: </span><span class="p">[</span>
      <span class="s">&#39;docpad.js&#39;</span>
      <span class="s">&#39;docpad.coffee&#39;</span>
      <span class="s">&#39;docpad.json&#39;</span>
      <span class="s">&#39;docpad.cson&#39;</span>
    <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugin directories to load</p></div></div><div class="code"><div class="wrapper">    <span class="nv">pluginPaths: </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's plugins directory</p></div></div><div class="code"><div class="wrapper">    <span class="nv">pluginsPaths: </span><span class="p">[</span>
      <span class="s">&#39;node_modules&#39;</span><span class="p">,</span>
      <span class="s">&#39;plugins&#39;</span>
    <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Paths that we should watch for reload changes in</p></div></div><div class="code"><div class="wrapper">    <span class="nv">reloadPaths: </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Paths that we should watch for regeneration changes in</p></div></div><div class="code"><div class="wrapper">    <span class="nv">regeneratePaths: </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's out directory</p></div></div><div class="code"><div class="wrapper">    <span class="nv">outPath: </span><span class="s">&#39;out&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's src directory</p></div></div><div class="code"><div class="wrapper">    <span class="nv">srcPath: </span><span class="s">&#39;src&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's documents directories
relative to the srcPath</p></div></div><div class="code"><div class="wrapper">    <span class="nv">documentsPaths: </span><span class="p">[</span>
      <span class="s">&#39;documents&#39;</span>
    <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's files directories
relative to the srcPath</p></div></div><div class="code"><div class="wrapper">    <span class="nv">filesPaths: </span><span class="p">[</span>
      <span class="s">&#39;files&#39;</span>
      <span class="s">&#39;public&#39;</span>
    <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The website's layouts directory
relative to the srcPath</p></div></div><div class="code"><div class="wrapper">    <span class="nv">layoutsPaths: </span><span class="p">[</span>
      <span class="s">&#39;layouts&#39;</span>
    <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ignored file patterns during directory parsing</p></div></div><div class="code"><div class="wrapper">    <span class="nv">ignorePaths: </span><span class="kc">false</span>
    <span class="nv">ignoreHiddenFiles: </span><span class="kc">false</span>
    <span class="nv">ignoreCommonPatterns: </span><span class="kc">true</span>
    <span class="nv">ignoreCustomPatterns: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Server</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Server
The Express.js server that we want docpad to use</p></div></div><div class="code"><div class="wrapper">    <span class="nv">serverExpress: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The HTTP server that we want docpad to use</p></div></div><div class="code"><div class="wrapper">    <span class="nv">serverHttp: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extend Server
Whether or not we should extend the server with extra middleware and routing</p></div></div><div class="code"><div class="wrapper">    <span class="nv">extendServer: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Port
The port that the server should use
PORT - Heroku, Nodejitsu, Custom
VCAP<em>APP</em>PORT - AppFog
VMC<em>APP</em>PORT - CloudFoundry</p></div></div><div class="code"><div class="wrapper">    <span class="nv">port: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Max Age
The caching time limit that is sent to the client</p></div></div><div class="code"><div class="wrapper">    <span class="nv">maxAge: </span><span class="mi">86400000</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Which middlewares would you like us to activate
The standard middlewares (bodePArser, methodOverride, express router)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">middlewareStandard: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The standard bodyParser middleware</p></div></div><div class="code"><div class="wrapper">    <span class="nv">middlewareBodyParser: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The standard methodOverride middleware</p></div></div><div class="code"><div class="wrapper">    <span class="nv">middlewareMethodOverride: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The standard express router middleware</p></div></div><div class="code"><div class="wrapper">    <span class="nv">middlewareExpressRouter: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Our own 404 middleware</p></div></div><div class="code"><div class="wrapper">    <span class="nv">middleware404: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Our own 500 middleware</p></div></div><div class="code"><div class="wrapper">    <span class="nv">middleware500: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Logging</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log Level
Which level of logging should we actually output</p></div></div><div class="code"><div class="wrapper">    <span class="nv">logLevel: </span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="s">&#39;-d&#39;</span> <span class="k">in</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">)</span> <span class="k">then</span> <span class="mi">7</span> <span class="k">else</span> <span class="mi">6</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Logger
A caterpillar instance if we already have one</p></div></div><div class="code"><div class="wrapper">    <span class="nv">logger: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Growl
Whether or not to send notifications to growl when we have them</p></div></div><div class="code"><div class="wrapper">    <span class="nv">growl: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Catch uncaught exceptions</p></div></div><div class="code"><div class="wrapper">    <span class="nv">catchExceptions: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Report Errors
Whether or not we should report our errors back to DocPad
By default it is only enabled if we are not running inside a test</p></div></div><div class="code"><div class="wrapper">    <span class="nv">reportErrors: </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Report Statistics
Whether or not we should report statistics back to DocPad
By default it is only enabled if we are not running inside a test</p></div></div><div class="code"><div class="wrapper">    <span class="nv">reportStatistics: </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Airbrake Token</p></div></div><div class="code"><div class="wrapper">    <span class="nv">airbrakeToken: </span><span class="s">&#39;e7374dd1c5a346efe3895b9b0c1c0325&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>MixPanel Token</p></div></div><div class="code"><div class="wrapper">    <span class="nv">mixpanelToken: </span><span class="s">&#39;d0f9b33c0ec921350b5419352028577e&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Other</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Single Extensions
Whether or not we should render single extensions by default</p></div></div><div class="code"><div class="wrapper">    <span class="nv">renderSingleExtensions: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Passes
How many times should we render documents that reference other documents?</p></div></div><div class="code"><div class="wrapper">    <span class="nv">renderPasses: </span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check Version
Whether or not to check for newer versions of DocPad</p></div></div><div class="code"><div class="wrapper">    <span class="nv">checkVersion: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Welcome
Whether or not we should display any custom welcome callbacks</p></div></div><div class="code"><div class="wrapper">    <span class="nv">welcome: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prompts
Whether or not we should display any prompts</p></div></div><div class="code"><div class="wrapper">    <span class="nv">prompts: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Helper Url
Used for subscribing to newsletter, account information, and statistics etc</p></div></div><div class="code"><div class="wrapper">    <span class="nv">helperUrl: </span><span class="s">&#39;https://docpad.org/helper/&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Safe Mode
If enabled, we will try our best to sandbox our template rendering so that they cannot modify things outside of them
Not yet implemented</p></div></div><div class="code"><div class="wrapper">    <span class="nv">safeMode: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Template Data
What data would you like to expose to your templates</p></div></div><div class="code"><div class="wrapper">    <span class="nv">templateData: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Collections
A hash of functions that create collections</p></div></div><div class="code"><div class="wrapper">    <span class="nv">collections: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Events
A hash of event handlers</p></div></div><div class="code"><div class="wrapper">    <span class="nv">events: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Regenerate Every
Performs a rengeraete every x milliseconds, useful for always having the latest data</p></div></div><div class="code"><div class="wrapper">    <span class="nv">regenerateEvery: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Environment Configuration</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Locale Code
The code we shall use for our locale (e.g. en, fr, etc)</p></div></div><div class="code"><div class="wrapper">    <span class="nv">localeCode: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Environment
Whether or not we are in production or development
Separate environments using a comma or a space</p></div></div><div class="code"><div class="wrapper">    <span class="nv">env: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Environments
Environment specific configuration to over-ride the global configuration</p></div></div><div class="code"><div class="wrapper">    <span class="nv">environments:</span>
      <span class="nv">development:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Always refresh from server</p></div></div><div class="code"><div class="wrapper">        <span class="nv">maxAge: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Only do these if we are running standalone (aka not included in a module)</p></div></div><div class="code"><div class="wrapper">        <span class="nv">checkVersion: </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">and</span> <span class="sr">/docpad$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nv">welcome: </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">and</span> <span class="sr">/docpad$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nv">prompts: </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">and</span> <span class="sr">/docpad$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Regenerate Timer
When config.regenerateEvery is set to a value, we create a timer here</p></div></div><div class="code"><div class="wrapper">  <span class="nv">regenerateTimer: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the Configuration</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getConfig: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@config</span> <span class="o">or</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the Port</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getPort: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@getConfig</span><span class="p">().</span><span class="nx">port</span> <span class="o">?</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">?</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_APP_PORT</span> <span class="o">?</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VMC_APP_PORT</span> <span class="o">?</span> <span class="mi">9778</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Initialization Functions</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Construct DocPad
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">(instanceConfig,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">instanceConfig</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">instanceConfig</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Allow DocPad to have unlimited event listeners</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@setMaxListeners</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Setup configuration event wrappers</p></div></div><div class="code"><div class="wrapper">    <span class="nv">configEventContext = </span><span class="p">{</span><span class="nx">docpad</span><span class="p">}</span>  <span class="c1"># here to allow the config event context to persist between event calls</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@getEvents</span><span class="p">(),</span> <span class="nf">(eventName) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind to the event</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">on</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nf">(opts,next) -&gt;</span>
        <span class="nv">eventHandler = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getConfig</span><span class="p">().</span><span class="nx">events</span><span class="o">?</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire the config event handler for this event, if it exists</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">eventHandler</span><span class="p">)</span>
          <span class="nv">args = </span><span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span>
          <span class="nx">balUtil</span><span class="p">.</span><span class="nx">fireWithOptionalCallback</span><span class="p">(</span><span class="nx">eventHandler</span><span class="p">,</span><span class="nx">args</span><span class="p">,</span><span class="nx">configEventContext</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It doesn't exist, so lets continue</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span>
          <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create our action runner</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@actionRunnerInstance = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="s">&#39;sync&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
    <span class="vi">@actionRunnerInstance.total = </span><span class="kc">Infinity</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create our error runner</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@errorRunnerInstance = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="s">&#39;sync&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">and</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getDebugging</span><span class="p">()</span>
        <span class="nv">locale = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">()</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">reportError</span><span class="o">+</span><span class="s">&#39;\n&#39;</span><span class="o">+</span><span class="nx">locale</span><span class="p">.</span><span class="nx">errorFollows</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="vi">@errorRunnerInstance.total = </span><span class="kc">Infinity</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create our track runner</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@trackRunnerInstance = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="s">&#39;sync&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">and</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getDebugging</span><span class="p">()</span>
        <span class="nv">locale = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">()</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">trackError</span><span class="o">+</span><span class="s">&#39;\n&#39;</span><span class="o">+</span><span class="nx">locale</span><span class="p">.</span><span class="nx">errorFollows</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="vi">@trackRunnerInstance.total = </span><span class="kc">Infinity</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initialize a default logger</p></div></div><div class="code"><div class="wrapper">    <span class="nv">logger = </span><span class="k">new</span> <span class="nx">caterpillar</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span>
      <span class="nv">transports:</span>
        <span class="nv">formatter: module: </span><span class="nx">module</span>
    <span class="p">)</span>
    <span class="nx">@setLogger</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>
    <span class="nx">@setLogLevel</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log to bubbled events</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span><span class="nx">args</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Dereference and initialise advanced variables
we deliberately ommit initialTemplateData here, as it is setup in getTemplateData</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@slowPlugins = </span><span class="p">{}</span>
    <span class="vi">@loadedPlugins = </span><span class="p">{}</span>
    <span class="vi">@exchange = </span><span class="p">{}</span>
    <span class="vi">@pluginsTemplateData = </span><span class="p">{}</span>
    <span class="vi">@instanceConfig = </span><span class="p">{}</span>
    <span class="vi">@locales = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">dereference</span><span class="p">(</span><span class="nx">@locales</span><span class="p">)</span>
    <span class="vi">@userConfig = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">dereference</span><span class="p">(</span><span class="nx">@userConfig</span><span class="p">)</span>
    <span class="vi">@initialConfig = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">dereference</span><span class="p">(</span><span class="nx">@initialConfig</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we want to perform the initial configuration load automatically</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">instanceConfig</span><span class="p">.</span><span class="nx">load</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">docpad</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@action</span> <span class="s">&#39;load ready&#39;</span><span class="p">,</span> <span class="nx">instanceConfig</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">docpad</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Helpers</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Is Ignored Path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">isIgnoredPath: </span><span class="nf">(path,opts={}) -&gt;</span>
    <span class="nv">opts = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nv">ignorePaths: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignorePaths</span>
      <span class="nv">ignoreHiddenFiles: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreHiddenFiles</span>
      <span class="nv">ignoreCommonPatterns: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreCommonPatterns</span>
      <span class="nv">ignoreCustomPatterns: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreCustomPatterns</span>
    <span class="p">},</span><span class="nx">opts</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">isIgnoredPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="nx">opts</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Scan Directory</p></div></div><div class="code"><div class="wrapper">  <span class="nv">scandir: </span><span class="nf">(opts={}) -&gt;</span>
    <span class="nv">opts = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nv">ignorePaths: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignorePaths</span>
      <span class="nv">ignoreHiddenFiles: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreHiddenFiles</span>
      <span class="nv">ignoreCommonPatterns: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreCommonPatterns</span>
      <span class="nv">ignoreCustomPatterns: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreCustomPatterns</span>
    <span class="p">},</span><span class="nx">opts</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">scandir</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Watch Directory</p></div></div><div class="code"><div class="wrapper">  <span class="nv">watchdir: </span><span class="nf">(opts={}) -&gt;</span>
    <span class="nv">opts = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nv">ignorePaths: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignorePaths</span>
      <span class="nv">ignoreHiddenFiles: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreHiddenFiles</span>
      <span class="nv">ignoreCommonPatterns: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreCommonPatterns</span>
      <span class="nv">ignoreCustomPatterns: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">ignoreCustomPatterns</span>
    <span class="p">},</span><span class="nx">opts</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s">&#39;watchr&#39;</span><span class="p">).</span><span class="nx">watch</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Setup and Loading</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ready
next(err,docpadInstance)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ready: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">instanceConfig</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">instanceConfig</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Single Extensions</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@DocumentModel::defaults.renderSingleExtensions = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">renderSingleExtensions</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Version Check</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@compareVersion</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Welcome prepare</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@getDebugging</span><span class="p">()</span>
      <span class="nv">pluginsList = </span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">pluginName</span><span class="si">}</span><span class="s"> v</span><span class="si">#{</span><span class="nx">@loadedPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">].</span><span class="nx">version</span><span class="si">}</span><span class="s">&quot;</span>  <span class="k">for</span> <span class="nx">pluginName</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">@loadedPlugins</span><span class="p">).</span><span class="nx">sort</span><span class="p">()).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">pluginsList = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">@loadedPlugins</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Welcome log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">welcome</span><span class="p">,</span> <span class="s">&quot;v</span><span class="si">#{</span><span class="nx">@getVersion</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="nx">@log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">welcomePlugins</span><span class="p">,</span> <span class="nx">pluginsList</span><span class="p">)</span>
    <span class="nx">@log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">welcomeEnvironment</span><span class="p">,</span> <span class="nx">@getEnvironment</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>All done, forward our DocPad instance onto our creator</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">docpad</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Welcome</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span>  <span class="k">unless</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">welcome</span>
      <span class="nx">@emitSync</span><span class="p">(</span><span class="s">&#39;welcome&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">docpad</span><span class="p">},</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Track</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">@userConfig</span><span class="p">.</span><span class="nx">username</span>
        <span class="nv">lastLogin = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
        <span class="nv">countryCode = </span><span class="nx">@getCountryCode</span><span class="p">()</span>
        <span class="nv">languageCode = </span><span class="nx">@getLanguageCode</span><span class="p">()</span>
        <span class="nv">mixpanelInstance = </span><span class="nx">@getMixpanelInstance</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">mixpanelInstance</span>
          <span class="k">if</span> <span class="nx">@userConfig</span><span class="p">.</span><span class="nx">identified</span> <span class="o">isnt</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>identify the new user with mixpanel</p></div></div><div class="code"><div class="wrapper">            <span class="nx">mixpanelInstance</span><span class="p">.</span><span class="nx">people</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">@userConfig</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="p">{</span>
              <span class="nv">$email: </span><span class="nx">@userConfig</span><span class="p">.</span><span class="nx">email</span>
              <span class="nv">$name: </span><span class="nx">@userConfig</span><span class="p">.</span><span class="nx">name</span>
              <span class="nv">$username: </span><span class="nx">@userConfig</span><span class="p">.</span><span class="nx">username</span>
              <span class="nv">$created: </span><span class="nx">lastLogin</span>
              <span class="nv">$last_login: </span><span class="nx">lastLogin</span>
              <span class="nv">$country_code: </span><span class="nx">countryCode</span>
              <span class="nv">languageCode: </span><span class="nx">languageCode</span>
            <span class="p">})</span>
            <span class="nx">@updateUserConfig</span><span class="p">({</span>
              <span class="nv">identified: </span><span class="kc">true</span>
            <span class="p">})</span>
          <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only update last login if we are another day</p></div></div><div class="code"><div class="wrapper">            <span class="nx">mixpanelInstance</span><span class="p">.</span><span class="nx">people</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">@userConfig</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="p">{</span>
              <span class="nv">$last_login: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
            <span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad Ready</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="nx">@emitSync</span><span class="p">(</span><span class="s">&#39;docpadReady&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">docpad</span><span class="p">},</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run tasks</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load Configuration
next(err,config)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">load: </span><span class="nf">(instanceConfig,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">instanceConfig</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">instanceConfig</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="nx">instanceConfig</span> <span class="o">or=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Reset non persistant configurations</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@websitePackageConfig = </span><span class="p">{}</span>
    <span class="vi">@websiteConfig = </span><span class="p">{}</span>
    <span class="vi">@config = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Merge in the instance configurations</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">@instanceConfig</span><span class="p">,</span><span class="nx">instanceConfig</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare the Load Tasks</p></div></div><div class="code"><div class="wrapper">    <span class="nv">preTasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) =&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply the environment
websitePackageConfig.env is left out of the detection here as it is usually an object
that is already merged with our process.env by the environment runner
rather than a string which is the docpad convention</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@config.env = </span><span class="nx">@instanceConfig</span><span class="p">.</span><span class="nx">env</span> <span class="o">or</span> <span class="nx">@websiteConfig</span><span class="p">.</span><span class="nx">env</span> <span class="o">or</span> <span class="nx">@initialConfig</span><span class="p">.</span><span class="nx">env</span> <span class="o">or</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span>
      <span class="nv">envs = </span><span class="nx">@getEnvironments</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Merge configurations</p></div></div><div class="code"><div class="wrapper">      <span class="nv">configPackages = </span><span class="p">[</span><span class="nx">@initialConfig</span><span class="p">,</span> <span class="nx">@userConfig</span><span class="p">,</span> <span class="nx">@websiteConfig</span><span class="p">,</span> <span class="nx">@instanceConfig</span><span class="p">]</span>
      <span class="nv">configsToMerge = </span><span class="p">[</span><span class="nx">@config</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">configPackage</span> <span class="k">in</span> <span class="nx">configPackages</span>
        <span class="nx">configsToMerge</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">configPackage</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">env</span> <span class="k">in</span> <span class="nx">envs</span>
          <span class="nv">envConfig = </span><span class="nx">configPackage</span><span class="p">.</span><span class="nx">environments</span><span class="o">?</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span>
          <span class="nx">configsToMerge</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">envConfig</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">envConfig</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">safeDeepExtendPlainObjects</span><span class="p">(</span><span class="nx">configsToMerge</span><span class="p">...)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract and apply the server</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@setServer</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">server</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">server</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract and apply the logger</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@setLogger</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">logger</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">logger</span>
      <span class="nx">@setLogLevel</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">logLevel</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Resolve any paths</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@config.rootPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">)</span>
      <span class="vi">@config.outPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">,</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">outPath</span><span class="p">)</span>
      <span class="vi">@config.srcPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">,</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">srcPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Resolve Documents, Files, Layouts paths</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;documents&#39;</span><span class="p">,</span><span class="s">&#39;files&#39;</span><span class="p">,</span><span class="s">&#39;layouts&#39;</span><span class="p">]</span>
        <span class="nv">typePaths = </span><span class="nx">@config</span><span class="p">[</span><span class="nx">type</span><span class="o">+</span><span class="s">&#39;Paths&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">typePath</span><span class="p">,</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">typePaths</span>
          <span class="nx">typePaths</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">srcPath</span><span class="p">,</span><span class="nx">typePath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Resolve Plugins paths</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;plugins&#39;</span><span class="p">]</span>
        <span class="nv">typePaths = </span><span class="nx">@config</span><span class="p">[</span><span class="nx">type</span><span class="o">+</span><span class="s">&#39;Paths&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">typePath</span><span class="p">,</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">typePaths</span>
          <span class="nx">typePaths</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">,</span><span class="nx">typePath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind the error handler, so we don't crash on errors</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">catchExceptions</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">setMaxListeners</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&#39;uncaughtException&#39;</span><span class="p">,</span> <span class="nx">@error</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s">&#39;uncaughtException&#39;</span><span class="p">,</span> <span class="nx">@error</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Regenerate Timer</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">@regenerateTimer</span>
        <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">@regenerateTimer</span><span class="p">)</span>
        <span class="vi">@regenerateTimer = </span><span class="kc">null</span>
      <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">regenerateEvery</span>
        <span class="vi">@regenerateTimer = </span><span class="nx">setInterval</span><span class="p">(</span>
          <span class="nf">-&gt;</span>
            <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">renderInterval</span><span class="p">)</span>
            <span class="nx">docpad</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="s">&#39;generate&#39;</span><span class="p">)</span>
          <span class="nx">@config</span><span class="p">.</span><span class="nx">regenerateEvery</span>
        <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare the Post Tasks</p></div></div><div class="code"><div class="wrapper">      <span class="nv">postTasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) =&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">@config</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initialize</p></div></div><div class="code"><div class="wrapper">      <span class="nx">postTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
        <span class="nx">@loadPlugins</span><span class="p">(</span><span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load collections</p></div></div><div class="code"><div class="wrapper">      <span class="nx">postTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
        <span class="nx">@createCollections</span><span class="p">(</span><span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch plugins templateData</p></div></div><div class="code"><div class="wrapper">      <span class="nx">postTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
        <span class="nx">@emitSync</span><span class="p">(</span><span class="s">&#39;extendTemplateData&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">templateData</span><span class="o">:</span><span class="nx">@pluginsTemplateData</span><span class="p">},</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire the docpadLoaded event</p></div></div><div class="code"><div class="wrapper">      <span class="nx">postTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
        <span class="nx">@emitSync</span><span class="p">(</span><span class="s">&#39;docpadLoaded&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire post tasks</p></div></div><div class="code"><div class="wrapper">      <span class="nx">postTasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Normalize the userConfigPath</p></div></div><div class="code"><div class="wrapper">    <span class="nx">preTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">getHomePath</span> <span class="nf">(err,homePath) =&gt;</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nv">dropboxPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">homePath</span><span class="p">,</span><span class="s">&#39;Dropbox&#39;</span><span class="p">)</span>
        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">dropboxPath</span><span class="p">,</span> <span class="nf">(dropboxPathExists) =&gt;</span>
          <span class="nv">userConfigDirPath = </span><span class="k">if</span> <span class="nx">dropboxPathExists</span> <span class="k">then</span> <span class="nx">dropboxPath</span> <span class="k">else</span> <span class="nx">homePath</span>
          <span class="vi">@userConfigPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">userConfigDirPath</span><span class="p">,</span> <span class="nx">@userConfigPath</span><span class="p">)</span>
          <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load User's Configuration</p></div></div><div class="code"><div class="wrapper">    <span class="nx">preTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="nx">@loadConfigPath</span> <span class="nx">@userConfigPath</span><span class="p">,</span> <span class="nf">(err,data) =&gt;</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply loaded data</p></div></div><div class="code"><div class="wrapper">        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">@userConfig</span><span class="p">,</span> <span class="nx">data</span> <span class="o">or</span> <span class="p">{})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done loading</p></div></div><div class="code"><div class="wrapper">        <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load DocPad's Package Configuration</p></div></div><div class="code"><div class="wrapper">    <span class="nx">preTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="nx">@loadConfigPath</span> <span class="nx">@packagePath</span><span class="p">,</span> <span class="nf">(err,data) =&gt;</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">data</span> <span class="o">or=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Version</p></div></div><div class="code"><div class="wrapper">        <span class="vi">@version = </span><span class="nx">data</span><span class="p">.</span><span class="nx">version</span>
        <span class="nx">@getAirbrakeInstance</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nv">appVersion = </span><span class="nx">data</span><span class="p">.</span><span class="nx">version</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done loading</p></div></div><div class="code"><div class="wrapper">        <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load Website's Package Configuration</p></div></div><div class="code"><div class="wrapper">    <span class="nx">preTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="nv">rootPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@instanceConfig</span><span class="p">.</span><span class="nx">rootPath</span> <span class="o">or</span> <span class="nx">@initialConfig</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">)</span>
      <span class="nv">websitePackagePath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">rootPath</span><span class="p">,</span> <span class="nx">@instanceConfig</span><span class="p">.</span><span class="nx">packagePath</span> <span class="o">or</span> <span class="nx">@initialConfig</span><span class="p">.</span><span class="nx">packagePath</span><span class="p">)</span>
      <span class="nx">@loadConfigPath</span> <span class="nx">websitePackagePath</span><span class="p">,</span> <span class="nf">(err,data) =&gt;</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">data</span> <span class="o">or=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply loaded data</p></div></div><div class="code"><div class="wrapper">        <span class="vi">@websitePackageConfig = </span><span class="nx">data</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done loading</p></div></div><div class="code"><div class="wrapper">        <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read the .env file if it exists</p></div></div><div class="code"><div class="wrapper">    <span class="nx">preTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="nv">rootPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@instanceConfig</span><span class="p">.</span><span class="nx">rootPath</span> <span class="o">or</span> <span class="nx">@websitePackageConfig</span><span class="p">.</span><span class="nx">rootPath</span> <span class="o">or</span> <span class="nx">@initialConfig</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">)</span>
      <span class="nv">envPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">rootPath</span><span class="p">,</span> <span class="s">&#39;.env&#39;</span><span class="p">)</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">envPath</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span>  <span class="k">unless</span> <span class="nx">exists</span>
        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">envPath</span><span class="p">,</span> <span class="nf">(err,data) -&gt;</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="nv">result = </span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
          <span class="nv">lines = </span><span class="nx">result</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">)</span>
          <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">lines</span>
            <span class="nv">match = </span><span class="nx">line</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^([^=]+?)=(.*)/</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">match</span>
              <span class="nv">key = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
              <span class="nv">value = </span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
              <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load Website's Configuration</p></div></div><div class="code"><div class="wrapper">    <span class="nx">preTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
      <span class="nv">rootPath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@instanceConfig</span><span class="p">.</span><span class="nx">rootPath</span> <span class="o">or</span> <span class="nx">@initialConfig</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">)</span>
      <span class="nv">configPaths = </span><span class="nx">@instanceConfig</span><span class="p">.</span><span class="nx">configPaths</span> <span class="o">or</span> <span class="nx">@initialConfig</span><span class="p">.</span><span class="nx">configPaths</span>
      <span class="k">for</span> <span class="nx">configPath</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">configPaths</span>
        <span class="nx">configPaths</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pathUtil</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">rootPath</span><span class="p">,</span> <span class="nx">configPath</span><span class="p">)</span>
      <span class="nx">@loadConfigPaths</span> <span class="nx">configPaths</span><span class="p">,</span> <span class="nf">(err,data) =&gt;</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">data</span> <span class="o">or=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply loaded data</p></div></div><div class="code"><div class="wrapper">        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">@websiteConfig</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done loading</p></div></div><div class="code"><div class="wrapper">        <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run the load tasks synchronously</p></div></div><div class="code"><div class="wrapper">    <span class="nx">preTasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">install: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-Initialise the Website's modules</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@initNodeModules</span><span class="p">(</span>
      <span class="nv">path: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">rootPath</span>
      <span class="nv">output: </span><span class="kc">true</span>
      <span class="nv">next: </span><span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward on error?</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-load configuration</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">load</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clean
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">clean: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="p">{</span><span class="nx">rootPath</span><span class="p">,</span><span class="nx">outPath</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@config</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">renderCleaning</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clean collections</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">resetCollections</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clean files
but only if our outPath is not a parent of our rootPath</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">rootPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">outPath</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>our outPath is higher than our root path, so do not remove files</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>our outPath is not related or lower than our root path, so do remove it</p></div></div><div class="code"><div class="wrapper">        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">rmdirDeep</span> <span class="nx">outPath</span><span class="p">,</span> <span class="nf">(err,list,tree) -&gt;</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">renderCleaned</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">err</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Configuration</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update User Configuration</p></div></div><div class="code"><div class="wrapper">  <span class="nv">updateUserConfig: </span><span class="nf">(data={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">data</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">userConfigPath = </span><span class="nx">@userConfigPath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply back to our loaded configuration
does not apply to @config as we would have to reparse everything
and that appears to be an imaginary problem</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">@userConfig</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">data</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write it with CSON</p></div></div><div class="code"><div class="wrapper">    <span class="nx">CSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">@userConfig</span><span class="p">,</span> <span class="nf">(err,userConfigString) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write it</p></div></div><div class="code"><div class="wrapper">      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">userConfigPath</span><span class="p">,</span> <span class="nx">userConfigString</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load a configuration url
next(err,parsedData)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadConfigUrl: </span><span class="nf">(configUrl,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadingConfigUrl</span><span class="p">,</span> <span class="nx">configUrl</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read the URL</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">readPath</span> <span class="nx">configUrl</span><span class="p">,</span> <span class="nf">(err,body) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read the string using CSON</p></div></div><div class="code"><div class="wrapper">      <span class="nx">CSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load a configuration file
next(err,parsedData)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadConfigPath: </span><span class="nf">(configPath,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadingConfigPath</span><span class="p">,</span> <span class="nx">configPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check that it exists</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">configPath</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">exists</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read the path using CSON</p></div></div><div class="code"><div class="wrapper">      <span class="nx">CSON</span><span class="p">.</span><span class="nx">parseFile</span><span class="p">(</span><span class="nx">configPath</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load a series of configuration paths
next(err,parsedData)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadConfigPaths: </span><span class="nf">(configPaths,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">result = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure array</p></div></div><div class="code"><div class="wrapper">    <span class="nv">configPaths = </span><span class="p">[</span><span class="nx">configPaths</span><span class="p">]</span>  <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">configPaths</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Group</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read our files
On the first file that returns a result, exit</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">configPaths</span><span class="p">,</span> <span class="nf">(configPath) -&gt;</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">loadConfigPath</span> <span class="nx">configPath</span><span class="p">,</span> <span class="nf">(err,config) -&gt;</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="k">if</span> <span class="nx">config</span>
            <span class="nv">result = </span><span class="nx">config</span>
            <span class="nx">tasks</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run them synchronously</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create Collections
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">createCollections: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">config = </span><span class="nx">@config</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="vi">@database = </span><span class="nv">database = </span><span class="k">new</span> <span class="nx">FilesCollection</span><span class="p">()</span>
    <span class="vi">@collections = </span><span class="p">{}</span>
    <span class="vi">@blocks = </span><span class="p">{}</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">collections</span> <span class="o">or=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Standard Collections</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@setCollections</span><span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Standard Collections</p></div></div><div class="code"><div class="wrapper">      <span class="nv">documents: </span><span class="nx">database</span><span class="p">.</span><span class="nx">createLiveChildCollection</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">setQuery</span><span class="p">(</span><span class="s">&#39;isDocument&#39;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nv">$or:</span>
            <span class="nv">isDocument: </span><span class="kc">true</span>
            <span class="nv">fullPath: $startsWith: </span><span class="nx">config</span><span class="p">.</span><span class="nx">documentsPaths</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nf">(model) -&gt;</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">addingDocument</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">))</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">setDefaults</span><span class="p">({</span>
            <span class="nv">isDocument: </span><span class="kc">true</span>
            <span class="nv">render: </span><span class="kc">true</span>
            <span class="nv">write: </span><span class="kc">true</span>
          <span class="p">})</span>
        <span class="p">)</span>
      <span class="nv">files: </span><span class="nx">database</span><span class="p">.</span><span class="nx">createLiveChildCollection</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">setQuery</span><span class="p">(</span><span class="s">&#39;isFile&#39;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nv">$or:</span>
            <span class="nv">isFile: </span><span class="kc">true</span>
            <span class="nv">fullPath: $startsWith: </span><span class="nx">config</span><span class="p">.</span><span class="nx">filesPaths</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nf">(model) -&gt;</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">addingFile</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">))</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">setDefaults</span><span class="p">({</span>
            <span class="nv">isFile: </span><span class="kc">true</span>
            <span class="nv">render: </span><span class="kc">false</span>
            <span class="nv">write: </span><span class="kc">true</span>
          <span class="p">})</span>
        <span class="p">)</span>
      <span class="nv">layouts: </span><span class="nx">database</span><span class="p">.</span><span class="nx">createLiveChildCollection</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">setQuery</span><span class="p">(</span><span class="s">&#39;isLayout&#39;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nv">$or:</span>
            <span class="nv">isLayout: </span><span class="kc">true</span>
            <span class="nv">fullPath: $startsWith: </span><span class="nx">config</span><span class="p">.</span><span class="nx">layoutsPaths</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nf">(model) -&gt;</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">addingLayout</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">))</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">setDefaults</span><span class="p">({</span>
            <span class="nv">isLayout: </span><span class="kc">true</span>
            <span class="nv">render: </span><span class="kc">false</span>
            <span class="nv">write: </span><span class="kc">false</span>
          <span class="p">})</span>
        <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Special Collections</p></div></div><div class="code"><div class="wrapper">      <span class="nv">html: </span><span class="nx">database</span><span class="p">.</span><span class="nx">createLiveChildCollection</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">setQuery</span><span class="p">(</span><span class="s">&#39;isHTML&#39;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nv">$or:</span>
            <span class="nv">isDocument: </span><span class="kc">true</span>
            <span class="nv">isFile: </span><span class="kc">true</span>
          <span class="nv">outExtension: </span><span class="s">&#39;html&#39;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nf">(model) -&gt;</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">addingHtml</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">))</span>
        <span class="p">)</span>
      <span class="nv">stylesheet: </span><span class="nx">database</span><span class="p">.</span><span class="nx">createLiveChildCollection</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">setQuery</span><span class="p">(</span><span class="s">&#39;isStylesheet&#39;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nv">$or:</span>
            <span class="nv">isDocument: </span><span class="kc">true</span>
            <span class="nv">isFile: </span><span class="kc">true</span>
          <span class="nv">outExtension: $in: </span><span class="p">[</span>
            <span class="s">&#39;css&#39;</span><span class="p">,</span>
            <span class="s">&#39;scss&#39;</span><span class="p">,</span> <span class="s">&#39;sass&#39;</span><span class="p">,</span>
            <span class="s">&#39;styl&#39;</span><span class="p">,</span> <span class="s">&#39;stylus&#39;</span>
            <span class="s">&#39;less&#39;</span>
          <span class="p">]</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nf">(model) -&gt;</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">addingStylesheet</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">))</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">setDefaults</span><span class="p">({</span>
            <span class="nv">referencesOthers: </span><span class="kc">true</span>
          <span class="p">})</span>
        <span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Blocks</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@setBlocks</span><span class="p">(</span>
      <span class="nv">meta: </span><span class="k">new</span> <span class="nx">MetaCollection</span><span class="p">()</span>
      <span class="nv">scripts: </span><span class="k">new</span> <span class="nx">ScriptsCollection</span><span class="p">()</span>
      <span class="nv">styles: </span><span class="k">new</span> <span class="nx">StylesCollection</span><span class="p">()</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Custom Collections Group</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span><span class="p">(</span><span class="s">&#39;extendCollections&#39;</span><span class="p">,{},</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cycle through Custom Collections</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="nf">(fn,name) -&gt;</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="k">if</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">2</span> <span class="c1"># callback</span>
          <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span> <span class="nx">docpad</span><span class="p">,</span> <span class="nx">database</span><span class="p">,</span> <span class="nf">(err,collection) -&gt;</span>
            <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
            <span class="k">if</span> <span class="nx">collection</span>
              <span class="nx">collection</span><span class="p">.</span><span class="nx">live</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>  <span class="c1"># make it a live collection</span>
              <span class="nx">docpad</span><span class="p">.</span><span class="nx">setCollection</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">collection</span><span class="p">)</span>  <span class="c1"># apply the collection</span>
            <span class="nx">complete</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nv">collection = </span><span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">docpad</span><span class="p">,</span><span class="nx">database</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">collection</span>
            <span class="nx">collection</span><span class="p">.</span><span class="nx">live</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>  <span class="c1"># make it a live collection</span>
            <span class="nx">docpad</span><span class="p">.</span><span class="nx">setCollection</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">collection</span><span class="p">)</span>  <span class="c1"># apply the collection</span>
          <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run Custom collections</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Reset Collections
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">resetCollections: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Perform a complete clean of our collections</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@getDatabase</span><span class="p">().</span><span class="nx">reset</span><span class="p">([])</span>
    <span class="nx">@getBlock</span><span class="p">(</span><span class="s">&#39;meta&#39;</span><span class="p">).</span><span class="nx">reset</span><span class="p">([]).</span><span class="nx">add</span><span class="p">([</span>
      <span class="s">&#39;&lt;meta http-equiv=&quot;X-Powered-By&quot; content=&quot;DocPad&quot;/&gt;&#39;</span>
    <span class="p">])</span>
    <span class="nx">@getBlock</span><span class="p">(</span><span class="s">&#39;scripts&#39;</span><span class="p">).</span><span class="nx">reset</span><span class="p">([])</span>
    <span class="nx">@getBlock</span><span class="p">(</span><span class="s">&#39;styles&#39;</span><span class="p">).</span><span class="nx">reset</span><span class="p">([])</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Perform any plugin extensions to what we just cleaned
and forward</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@emitSync</span><span class="p">(</span><span class="s">&#39;populateCollections&#39;</span><span class="p">,{},</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Init Git Repo
next(err,results)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">initGitRepo: </span><span class="nf">(opts) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">initGitRepo</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Init Node Modules
next(err,results)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">initNodeModules: </span><span class="nf">(opts={}) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nx">opts</span><span class="p">.</span><span class="nx">force</span> <span class="o">?=</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">force</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">output</span> <span class="o">?=</span> <span class="nx">@getDebugging</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">initNodeModules</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Logging</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set Log Level</p></div></div><div class="code"><div class="wrapper">  <span class="nv">setLogLevel: </span><span class="nf">(level) -&gt;</span>
    <span class="nx">@getLogger</span><span class="p">().</span><span class="nx">setLevel</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Are we debugging?</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getLogLevel: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">logLevel</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Are we debugging?</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getDebugging: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@getLogLevel</span><span class="p">()</span> <span class="o">is</span> <span class="mi">7</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle a fatal error</p></div></div><div class="code"><div class="wrapper">  <span class="nv">fatal: </span><span class="nf">(err) =&gt;</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="k">return</span> <span class="nx">@</span>  <span class="k">unless</span> <span class="nx">err</span>
    <span class="nx">@error</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#39;err&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="k">if</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">catchExceptions</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">throw</span> <span class="nx">err</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">  <span class="nv">log: </span><span class="nf">(args...) =&gt;</span>
    <span class="nv">logger = </span><span class="nx">@getLogger</span><span class="p">()</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span><span class="nx">args</span><span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle an error</p></div></div><div class="code"><div class="wrapper">  <span class="nv">error: </span><span class="nf">(err,type=&#39;err&#39;,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">!</span><span class="nx">err</span> <span class="o">or</span> <span class="nx">err</span><span class="p">.</span><span class="nx">logged</span>
      <span class="nx">next</span><span class="o">?</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log the error only if it hasn't been logged already</p></div></div><div class="code"><div class="wrapper">    <span class="nv">err.logged = </span><span class="kc">true</span>
    <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="o">?</span>
    <span class="nv">err.logged = </span><span class="kc">true</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">errorOccured</span><span class="p">,</span> <span class="s">&#39;\n&#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span> <span class="o">?</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span><span class="nx">locale</span><span class="p">.</span><span class="nx">errorOccured</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="nv">airbrake = </span><span class="nx">@getAirbrakeInstance</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">airbrake</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">      <span class="nv">err.params =</span>
        <span class="nv">docpadVersion: </span><span class="nx">@version</span>
        <span class="nv">docpadConfig: </span><span class="nx">@config</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@getErrorRunner</span><span class="p">().</span><span class="nx">pushAndRun</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">airbrake</span><span class="p">.</span><span class="nx">notify</span> <span class="nx">err</span><span class="p">,</span> <span class="nf">(airbrakeErr,airbrakeUrl) -&gt;</span>
          <span class="k">if</span> <span class="nx">airbrakeErr</span>
            <span class="nx">complete</span><span class="p">(</span><span class="nx">airbrakeErr</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">errorLoggedTo</span><span class="p">,</span> <span class="nx">airbrakeUrl</span><span class="p">))</span>
            <span class="nx">complete</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">next</span><span class="o">?</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle a warning</p></div></div><div class="code"><div class="wrapper">  <span class="nv">warn: </span><span class="nf">(message,err,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span><span class="nx">locale</span><span class="p">.</span><span class="nx">warnOccured</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Perform a growl notification</p></div></div><div class="code"><div class="wrapper">  <span class="nv">notify: </span><span class="nf">(message,opts) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="nv">growl = </span><span class="nx">@getGrowlInstance</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">growl</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">      <span class="k">try</span>
        <span class="nx">growl</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="nx">opts</span><span class="p">)</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nx">@err</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="s">&#39;warn&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Track</p></div></div><div class="code"><div class="wrapper">  <span class="nv">track: </span><span class="nf">(name,data={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="nv">mixpanelInstance = </span><span class="nx">@getMixpanelInstance</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">mixpanelInstance</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">@userConfig</span><span class="o">?</span><span class="p">.</span><span class="nx">username</span>
        <span class="nv">data.distinct_id = </span><span class="nx">@userConfig</span><span class="p">.</span><span class="nx">username</span>
        <span class="nv">data.username = </span><span class="nx">@userConfig</span><span class="p">.</span><span class="nx">username</span>
      <span class="k">if</span> <span class="nx">@websitePackageConfig</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span>
        <span class="nv">data.websiteName = </span><span class="nx">@websitePackageConfig</span><span class="p">.</span><span class="nx">name</span>
      <span class="nv">data.version = </span><span class="nx">@version</span>
      <span class="nv">data.platform = </span><span class="nx">process</span><span class="p">.</span><span class="nx">platform</span>
      <span class="nv">data.environment = </span><span class="nx">@getEnvironment</span><span class="p">()</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@loadedPlugins</span><span class="p">,</span> <span class="nf">(value,key) -&gt;</span>
        <span class="nx">data</span><span class="p">[</span><span class="s">&#39;plugin-&#39;</span><span class="o">+</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">version</span> <span class="o">or</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@getTrackRunner</span><span class="p">().</span><span class="nx">pushAndRun</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">mixpanelInstance</span><span class="p">.</span><span class="nx">track</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
          <span class="nx">next</span><span class="o">?</span><span class="p">()</span>
          <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Models and Collections</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Instantiate a File</p></div></div><div class="code"><div class="wrapper">  <span class="nv">createFile: </span><span class="nf">(data={},options={}) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">options = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
      <span class="nv">outDirPath: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">outPath</span>
    <span class="p">,</span><span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create and return</p></div></div><div class="code"><div class="wrapper">    <span class="nv">file = </span><span class="k">new</span> <span class="nx">FileModel</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;render&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span><span class="p">(</span><span class="s">&#39;render&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return</p></div></div><div class="code"><div class="wrapper">    <span class="nx">file</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Instantiate a Document</p></div></div><div class="code"><div class="wrapper">  <span class="nv">createDocument: </span><span class="nf">(data={},options={}) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">options = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
      <span class="nv">outDirPath: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">outPath</span>
    <span class="p">,</span><span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create and return</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DocumentModel</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch a layout</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;getLayout&#39;</span><span class="p">,</span> <span class="nf">(opts,next) -&gt;</span>
      <span class="p">{</span><span class="nx">layoutId</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span>
      <span class="nv">layouts = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="s">&#39;layouts&#39;</span><span class="p">)</span>
      <span class="nv">layout = </span><span class="nx">layouts</span><span class="p">.</span><span class="nx">fuzzyFindOne</span><span class="p">(</span><span class="nx">layoutId</span><span class="p">)</span>
      <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,{</span><span class="nx">layout</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;render&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span><span class="p">(</span><span class="s">&#39;render&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render document</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;renderDocument&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span><span class="p">(</span><span class="s">&#39;renderDocument&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure File</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureFile: </span><span class="nf">(data={},options={}) =&gt;</span>
    <span class="nv">database = </span><span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="nv">result = </span><span class="nx">database</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nv">fullPath: </span><span class="nx">data</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">)</span>
    <span class="k">unless</span> <span class="nx">result</span>
      <span class="nv">result = </span><span class="nx">@createFile</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
      <span class="nx">database</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
    <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure Document</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureDocument: </span><span class="nf">(data={},options={}) =&gt;</span>
    <span class="nv">database = </span><span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="nv">result = </span><span class="nx">database</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nv">fullPath: </span><span class="nx">data</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">)</span>
    <span class="k">unless</span> <span class="nx">result</span>
      <span class="nv">result = </span><span class="nx">@createDocument</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
      <span class="nx">database</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
    <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure File or Document</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ensureFileOrDocument: </span><span class="nf">(data={},options={}) =&gt;</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">database = </span><span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="nv">fileFullPath = </span><span class="nx">data</span><span class="p">.</span><span class="nx">fullPath</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="nv">result = </span><span class="nx">database</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nv">fullPath: </span><span class="nx">fileFullPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create result</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we have a file path to compare</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">fileFullPath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we have a document or layout</p></div></div><div class="code"><div class="wrapper">        <span class="k">for</span> <span class="nx">dirPath</span> <span class="k">in</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">documentsPaths</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">layoutsPaths</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">fileFullPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">dirPath</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">relativePath</span> <span class="o">or=</span> <span class="nx">fileFullPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">dirPath</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[\/\\]/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="nv">result = </span><span class="nx">@createDocument</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
            <span class="k">break</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we have a file</p></div></div><div class="code"><div class="wrapper">        <span class="k">unless</span> <span class="nx">result</span>
          <span class="k">for</span> <span class="nx">dirPath</span> <span class="k">in</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">filesPaths</span>
            <span class="k">if</span> <span class="nx">fileFullPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">dirPath</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
              <span class="nx">data</span><span class="p">.</span><span class="nx">relativePath</span> <span class="o">or=</span> <span class="nx">fileFullPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">dirPath</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[\/\\]/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
              <span class="nv">result = </span><span class="nx">@createFile</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
              <span class="k">break</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise, create a file anyway</p></div></div><div class="code"><div class="wrapper">      <span class="k">unless</span> <span class="nx">result</span>
        <span class="nv">result = </span><span class="nx">@createDocument</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add result to database</p></div></div><div class="code"><div class="wrapper">      <span class="nx">database</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return</p></div></div><div class="code"><div class="wrapper">    <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse a file directory
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parseFileDirectory: </span><span class="nf">(opts={},next) -&gt;</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">createFunction</span> <span class="o">?=</span> <span class="nx">@createFile</span>
    <span class="k">return</span> <span class="nx">@parseDirectory</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse a document directory
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parseDocumentDirectory: </span><span class="nf">(opts={},next) -&gt;</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">createFunction</span> <span class="o">?=</span> <span class="nx">@createDocument</span>
    <span class="k">return</span> <span class="nx">@parseDirectory</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse a directory
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parseDirectory: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">path</span><span class="p">,</span><span class="nx">createFunction</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span>
    <span class="nv">filesToLoad = </span><span class="k">new</span> <span class="nx">FilesCollection</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if the directory exists</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderDirectoryNonexistant</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderDirectoryParsing</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Files</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@scandir</span><span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Path</p></div></div><div class="code"><div class="wrapper">      <span class="nv">path: </span><span class="nx">path</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>File Action</p></div></div><div class="code"><div class="wrapper">      <span class="nv">fileAction: </span><span class="nf">(fileFullPath,fileRelativePath,nextFile,fileStat) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">        <span class="nv">data =</span>
          <span class="nv">fullPath: </span><span class="nx">fileFullPath</span>
          <span class="nv">relativePath: </span><span class="nx">fileRelativePath</span>
        <span class="nv">options =</span>
          <span class="nv">stat: </span><span class="nx">fileStat</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create file</p></div></div><div class="code"><div class="wrapper">        <span class="nv">file = </span><span class="nx">createFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span>
        <span class="nx">filesToLoad</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">        <span class="nx">nextFile</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">      <span class="nv">next: </span><span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderDirectoryParsed</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load the files</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">loadFiles</span> <span class="p">{</span><span class="nx">collection</span><span class="o">:</span><span class="nx">filesToLoad</span><span class="p">},</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Plugins</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a plugin by it's name</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getPlugin: </span><span class="nf">(pluginName) -&gt;</span>
    <span class="nx">@loadedPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we have any plugins</p></div></div><div class="code"><div class="wrapper">  <span class="nv">hasPlugins: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">@loadedPlugins</span><span class="p">)</span> <span class="o">is</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load Plugins</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadPlugins: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Snore</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@slowPlugins = </span><span class="p">{}</span>
    <span class="nv">snore = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">createSnore</span> <span class="nf">-&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;notice&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginsSlow</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">slowPlugins</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
      <span class="nv">docpad.slowPlugins = </span><span class="p">{}</span>
      <span class="nx">snore</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load website plugins</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">pluginsPaths</span> <span class="o">or</span> <span class="p">[],</span> <span class="nf">(pluginsPath) =&gt;</span>
      <span class="nv">exists = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">pluginsPath</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">exists</span>
        <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
          <span class="nx">@loadPluginsIn</span><span class="p">(</span><span class="nx">pluginsPath</span><span class="p">,</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load specific plugins</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">pluginPaths</span> <span class="o">or</span> <span class="p">[],</span> <span class="nf">(pluginPath) =&gt;</span>
      <span class="nv">exists = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">pluginPath</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">exists</span>
        <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) =&gt;</span>
          <span class="nx">@loadPlugin</span><span class="p">(</span><span class="nx">pluginPath</span><span class="p">,</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Execute the loading asynchronously</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loaded Plugin
Checks if a plugin was loaded succesfully
next(err,loaded)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadedPlugin: </span><span class="nf">(pluginName,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="nv">loaded = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">loadedPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">loaded</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load PLugin
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadPlugin: </span><span class="nf">(fileFullPath,_next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">config = </span><span class="nx">@config</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="nv">next = </span><span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove from slow plugins</p></div></div><div class="code"><div class="wrapper">      <span class="k">delete</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">slowPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">_next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare variables</p></div></div><div class="code"><div class="wrapper">    <span class="nv">loader = </span><span class="k">new</span> <span class="nx">PluginLoader</span><span class="p">(</span>
      <span class="nv">dirPath: </span><span class="nx">fileFullPath</span>
      <span class="nv">docpad: </span><span class="nx">@</span>
      <span class="nv">BasePlugin: </span><span class="nx">BasePlugin</span>
    <span class="p">)</span>
    <span class="nv">pluginName = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">pluginName</span>
    <span class="nv">enabled = </span><span class="p">(</span>
      <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">enableUnlistedPlugins</span>  <span class="o">and</span>  <span class="nx">config</span><span class="p">.</span><span class="nx">enabledPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">]</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span><span class="p">)</span>  <span class="o">or</span>
      <span class="nx">config</span><span class="p">.</span><span class="nx">enabledPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">]</span> <span class="o">is</span> <span class="kc">true</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we've already been loaded, then exit early as there is no use for us to load again</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">loadedPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">]</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">_next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add to loading stores</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">slowPlugins</span><span class="p">[</span><span class="nx">pluginName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">enabled</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skip</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginSkipped</span><span class="p">,</span> <span class="nx">pluginName</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginLoading</span><span class="p">,</span> <span class="nx">pluginName</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check existance</p></div></div><div class="code"><div class="wrapper">      <span class="nx">loader</span><span class="p">.</span><span class="nx">exists</span> <span class="nf">(err,exists) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error or doesn't exist?</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">exists</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check support</p></div></div><div class="code"><div class="wrapper">        <span class="nx">loader</span><span class="p">.</span><span class="nx">unsupported</span> <span class="nf">(err,unsupported) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Unsupported?</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">unsupported</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Version?</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="nx">unsupported</span> <span class="o">is</span> <span class="s">&#39;version&#39;</span> <span class="o">and</span>  <span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">skipUnsupportedPlugins</span> <span class="o">is</span> <span class="kc">false</span>
              <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginContinued</span><span class="p">,</span> <span class="nx">pluginName</span><span class="p">)</span>
            <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Type?</p></div></div><div class="code"><div class="wrapper">              <span class="k">if</span> <span class="nx">unsupported</span> <span class="o">is</span> <span class="s">&#39;type&#39;</span>
                <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginSkippedDueTo</span><span class="p">,</span> <span class="nx">pluginName</span><span class="p">,</span> <span class="nx">unsupported</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Something else?</p></div></div><div class="code"><div class="wrapper">              <span class="k">else</span>
                <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginSkippedDueTo</span><span class="p">,</span> <span class="nx">pluginName</span><span class="p">,</span> <span class="nx">unsupported</span><span class="p">)</span>
              <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load the class</p></div></div><div class="code"><div class="wrapper">          <span class="nx">loader</span><span class="p">.</span><span class="nx">load</span> <span class="nf">(err) -&gt;</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create an instance</p></div></div><div class="code"><div class="wrapper">            <span class="nx">loader</span><span class="p">.</span><span class="nx">create</span> <span class="p">{},</span> <span class="nf">(err,pluginInstance) -&gt;</span>
              <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add to plugin stores</p></div></div><div class="code"><div class="wrapper">              <span class="nx">docpad</span><span class="p">.</span><span class="nx">loadedPlugins</span><span class="p">[</span><span class="nx">loader</span><span class="p">.</span><span class="nx">pluginName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pluginInstance</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log completion</p></div></div><div class="code"><div class="wrapper">              <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginLoaded</span><span class="p">,</span> <span class="nx">pluginName</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">              <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load Plugins</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadPluginsIn: </span><span class="nf">(pluginsPath, next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load Plugins</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginsLoadingFor</span><span class="p">,</span> <span class="nx">pluginsPath</span><span class="p">)</span>
    <span class="nx">@scandir</span><span class="p">(</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Path</p></div></div><div class="code"><div class="wrapper">      <span class="nv">path: </span><span class="nx">pluginsPath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skip files</p></div></div><div class="code"><div class="wrapper">      <span class="nv">fileAction: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle directories</p></div></div><div class="code"><div class="wrapper">      <span class="nv">dirAction: </span><span class="nf">(fileFullPath,fileRelativePath,_nextFile) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">        <span class="nv">pluginName = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fileFullPath</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">_nextFile</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">fileFullPath</span> <span class="o">is</span> <span class="nx">pluginsPath</span>
        <span class="nv">nextFile = </span><span class="nf">(err,skip) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">docpad</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginFailedToLoad</span><span class="p">,</span> <span class="nx">pluginName</span><span class="p">,</span> <span class="nx">fileFullPath</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;\n&#39;</span><span class="o">+</span><span class="nx">locale</span><span class="p">.</span><span class="nx">errorFollows</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">_nextFile</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">skip</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">loadPlugin</span> <span class="nx">fileFullPath</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">nextFile</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">      <span class="nv">next: </span><span class="nf">(err) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">pluginsLoadedFor</span><span class="p">,</span> <span class="nx">pluginsPath</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Utilities</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Utilities: Misc</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compare current DocPad version to the latest</p></div></div><div class="code"><div class="wrapper">  <span class="nv">compareVersion: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@</span>  <span class="k">unless</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">checkVersion</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">packageCompare</span><span class="p">(</span>
      <span class="nv">local: </span><span class="nx">@packagePath</span>
      <span class="nv">remote: </span><span class="nx">@config</span><span class="p">.</span><span class="nx">latestPackageUrl</span>
      <span class="nv">newVersionCallback: </span><span class="nf">(details) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">notify</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">upgradeNotification</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;notice&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">upgradeDetails</span><span class="p">,</span> <span class="nx">details</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">details</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">details</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">upgradeUrl</span> <span class="o">or</span> <span class="nx">details</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">installUrl</span> <span class="o">or</span> <span class="nx">details</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">homepage</span><span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Utilities: Exchange</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get Exchange
Get the exchange data
Requires internet access
next(err,exchange)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">getExchange: </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if it is stored locally</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">@exchange</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">@exchange</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise fetch it from the exchangeUrl</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@loadConfigUrl</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">exchangeUrl</span><span class="p">,</span> <span class="nf">(err,parsedData) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
      <span class="vi">@exchange = </span><span class="nx">parsedData</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">parsedData</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Utilities: Skeletons</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install a Skeleton to a Directory
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">installSkeleton: </span><span class="nf">(skeletonModel,destinationPath,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">packagePath = </span><span class="nx">pathUtil</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">destinationPath</span><span class="p">,</span> <span class="s">&#39;package.json&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Configure</p></div></div><div class="code"><div class="wrapper">    <span class="nv">repoConfig =</span>
      <span class="nv">path: </span><span class="nx">destinationPath</span>
      <span class="nv">url: </span><span class="nx">skeletonModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;repo&#39;</span><span class="p">)</span>
      <span class="nv">branch: </span><span class="nx">skeletonModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">)</span>
      <span class="nv">remote: </span><span class="s">&#39;skeleton&#39;</span>
      <span class="nv">output: </span><span class="kc">true</span>
      <span class="nv">next: </span><span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initialise the Website's modules for the first time</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">initNodeModules</span><span class="p">(</span>
          <span class="nv">path: </span><span class="nx">destinationPath</span>
          <span class="nv">output: </span><span class="kc">true</span>
          <span class="nv">next: </span><span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done</p></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
        <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if the skeleton path already exists</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">ensurePath</span> <span class="nx">destinationPath</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initalize the git repository</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">initGitRepo</span><span class="p">(</span><span class="nx">repoConfig</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Utilities: Files</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loading files
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadFiles: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="nv">database = </span><span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="p">{</span><span class="nx">collection</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadingFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>After</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;loadAfter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadedFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch</p></div></div><div class="code"><div class="wrapper">    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(file) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">      <span class="nv">fileRelativePath = </span><span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;relativePath&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadingFile</span><span class="p">,</span> <span class="nx">fileRelativePath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load the file</p></div></div><div class="code"><div class="wrapper">      <span class="nx">file</span><span class="p">.</span><span class="nx">load</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadingFileFailed</span><span class="p">,</span> <span class="nx">fileRelativePath</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;\n&quot;</span><span class="o">+</span><span class="nx">locale</span><span class="p">.</span><span class="nx">errorFollows</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">        <span class="nv">fileIgnored = </span><span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;ignored&#39;</span><span class="p">)</span>
        <span class="nv">fileParse = </span><span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;parse&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ignored?</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">fileIgnored</span> <span class="o">or</span> <span class="p">(</span><span class="nx">fileParse</span><span class="o">?</span> <span class="o">and</span> <span class="o">!</span><span class="nx">fileParse</span><span class="p">)</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadingFileIgnored</span><span class="p">,</span> <span class="nx">fileRelativePath</span><span class="p">)</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">loadedFile</span><span class="p">,</span> <span class="nx">fileRelativePath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Store Document</p></div></div><div class="code"><div class="wrapper">        <span class="nx">database</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start contextualizing</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;loadBefore&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Contextualize files
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">contextualizeFiles: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="p">{</span><span class="nx">collection</span><span class="p">,</span><span class="nx">templateData</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">contextualizingFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>After</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;contextualizeAfter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">contextualizedFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set progress indicator</p></div></div><div class="code"><div class="wrapper">    <span class="nx">opts</span><span class="p">.</span><span class="nx">setProgressIndicator</span><span class="o">?</span> <span class="nf">-&gt;</span> <span class="p">[</span><span class="s">&#39;contextualizeFiles&#39;</span><span class="p">,</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">completed</span><span class="p">,</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">total</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch</p></div></div><div class="code"><div class="wrapper">    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(file,index) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">contextualize</span><span class="p">(</span><span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start contextualizing</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;contextualizeBefore&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">,</span><span class="nx">templateData</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render files
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderFiles: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="p">{</span><span class="nx">collection</span><span class="p">,</span><span class="nx">templateData</span><span class="p">,</span><span class="nx">renderPasses</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderingFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>After</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;renderAfter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderedFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render File</p></div></div><div class="code"><div class="wrapper">    <span class="nv">renderFile = </span><span class="nf">(fileToRender,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skip?</p></div></div><div class="code"><div class="wrapper">      <span class="nv">dynamic = </span><span class="nx">fileToRender</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;dynamic&#39;</span><span class="p">)</span>
      <span class="nv">render = </span><span class="nx">fileToRender</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;render&#39;</span><span class="p">)</span>
      <span class="nv">relativePath = </span><span class="nx">fileToRender</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;relativePath&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">dynamic</span> <span class="o">or</span> <span class="p">(</span><span class="nx">render</span><span class="o">?</span> <span class="o">and</span> <span class="o">!</span><span class="nx">render</span><span class="p">)</span> <span class="o">or</span> <span class="o">!</span><span class="nx">relativePath</span> <span class="o">or</span> <span class="nx">fileToRender</span><span class="p">.</span><span class="nx">render</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="nx">next</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">fileToRender</span><span class="p">.</span><span class="nx">render</span><span class="p">({</span><span class="nx">templateData</span><span class="p">},</span><span class="nx">next</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">fileToRender</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Collection</p></div></div><div class="code"><div class="wrapper">    <span class="nv">renderCollection = </span><span class="nf">(collectionToRender,_opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">      <span class="nx">_opts</span><span class="p">.</span><span class="nx">total</span> <span class="o">?=</span> <span class="nx">collectionToRender</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">_opts</span><span class="p">.</span><span class="nx">renderPass</span> <span class="o">?=</span> <span class="mi">1</span>
      <span class="nx">_opts</span><span class="p">.</span><span class="nx">offset</span> <span class="o">?=</span> <span class="mi">0</span>
      <span class="nv">subTasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
      <span class="nx">opts</span><span class="p">.</span><span class="nx">setProgressIndicator</span><span class="o">?</span> <span class="nf">-&gt;</span> <span class="p">[</span><span class="s">&#39;renderFiles&#39;</span><span class="o">+</span><span class="p">(</span><span class="k">if</span> <span class="nx">_opts</span><span class="p">.</span><span class="nx">renderPass</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="s">&quot; (pass </span><span class="si">#{</span><span class="nx">_opts</span><span class="p">.</span><span class="nx">renderPass</span><span class="si">}</span><span class="s">)&quot;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">),</span><span class="nx">_opts</span><span class="p">.</span><span class="nx">offset</span><span class="o">+</span><span class="nx">subTasks</span><span class="p">.</span><span class="nx">completed</span><span class="p">,</span><span class="nx">_opts</span><span class="p">.</span><span class="nx">total</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cycle</p></div></div><div class="code"><div class="wrapper">      <span class="nx">collectionToRender</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(file) -&gt;</span>  <span class="nx">subTasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>  <span class="nx">renderFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire</p></div></div><div class="code"><div class="wrapper">      <span class="nx">subTasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">collectionToRender</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Queue the initial render</p></div></div><div class="code"><div class="wrapper">    <span class="nv">initialCollection = </span><span class="nx">collection</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="s">&#39;referencesOthers&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">)</span>
    <span class="nv">subsequentCollection = </span><span class="kc">null</span>
    <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
      <span class="nx">renderCollection</span> <span class="nx">initialCollection</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nv">subsequentCollection = </span><span class="nx">collection</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="s">&#39;referencesOthers&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">)</span>
        <span class="nx">renderCollection</span><span class="p">(</span><span class="nx">subsequentCollection</span><span class="p">,</span> <span class="p">{</span><span class="nx">offset</span><span class="o">:</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">subsequentCollection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">total</span><span class="o">:</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">},</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Queue the subsequent renders</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">renderPasses</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">each</span> <span class="p">[</span><span class="mi">2</span><span class="p">..</span><span class="nx">renderPasses</span><span class="p">],</span> <span class="nf">(renderPass) -&gt;</span>  <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">renderCollection</span><span class="p">(</span><span class="nx">subsequentCollection</span><span class="p">,</span> <span class="p">{</span><span class="nx">renderPass</span><span class="p">},</span> <span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire the queue</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;renderBefore&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">,</span><span class="nx">templateData</span><span class="p">},</span> <span class="nf">(err) =&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write files
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">writeFiles: </span><span class="nf">(opts={},next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="p">{</span><span class="nx">collection</span><span class="p">,</span><span class="nx">templateData</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">writingFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">    <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>After</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;writeAfter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">wroteFiles</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set progress indicator</p></div></div><div class="code"><div class="wrapper">    <span class="nx">opts</span><span class="p">.</span><span class="nx">setProgressIndicator</span><span class="o">?</span> <span class="nf">-&gt;</span> <span class="p">[</span><span class="s">&#39;writeFiles&#39;</span><span class="p">,</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">completed</span><span class="p">,</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">total</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cycle</p></div></div><div class="code"><div class="wrapper">    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(file,index) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skip</p></div></div><div class="code"><div class="wrapper">      <span class="nv">dynamic = </span><span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;dynamic&#39;</span><span class="p">)</span>
      <span class="nv">write = </span><span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
      <span class="nv">relativePath = </span><span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;relativePath&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">dynamic</span> <span class="o">or</span> <span class="p">(</span><span class="nx">write</span><span class="o">?</span> <span class="o">and</span> <span class="o">!</span><span class="nx">write</span><span class="p">)</span> <span class="o">or</span> <span class="o">!</span><span class="nx">relativePath</span>
        <span class="nx">complete</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">writeRendered</span><span class="o">?</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">writeRendered</span><span class="p">(</span><span class="nx">complete</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">write</span><span class="o">?</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">complete</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">complete</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">unknownModelInCollection</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start writing</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;writeBefore&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">collection</span><span class="p">,</span><span class="nx">templateData</span><span class="p">},</span> <span class="nf">(err) =&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=================================
Actions</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Perform an action
next(err,...), ... = any special arguments from the action</p></div></div><div class="code"><div class="wrapper">  <span class="nv">action: </span><span class="nf">(action,opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">runner = </span><span class="nx">@getActionRunner</span><span class="p">()</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Multiple actions?</p></div></div><div class="code"><div class="wrapper">    <span class="nv">actions = </span><span class="nx">action</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/[,\s]+/g</span>
    <span class="k">if</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">actions</span><span class="p">,</span> <span class="nf">(action) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span><span class="nx">opts</span><span class="p">,</span><span class="nx">complete</span><span class="p">)</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">sync</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">docpad</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">actionStart</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Next</p></div></div><div class="code"><div class="wrapper">    <span class="nx">next</span> <span class="o">?=</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
    <span class="nv">forward = </span><span class="nf">(args...) =&gt;</span>
      <span class="nx">@log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">actionFinished</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">wait</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">next</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Wrap</p></div></div><div class="code"><div class="wrapper">    <span class="nx">runner</span><span class="p">.</span><span class="nx">pushAndRun</span> <span class="nf">(complete) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch</p></div></div><div class="code"><div class="wrapper">      <span class="nv">fn = </span><span class="nx">docpad</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">complete</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">actionNonexistant</span><span class="p">,</span> <span class="nx">action</span><span class="p">)))</span>  <span class="k">unless</span> <span class="nx">fn</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Track</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">      <span class="nx">fn</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
        <span class="nx">forward</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
        <span class="nx">complete</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Generate</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate Prepare
opts = {reset}
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generatePrepare: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update generating flag</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad.generating = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">reset</span> <span class="o">is</span> <span class="kc">true</span>
      <span class="nv">docpad.filesByUrl = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log generating</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">renderGenerating</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">notify</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">toLocaleTimeString</span><span class="p">(),</span> <span class="nv">title: </span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderGeneratingNotification</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire plugins</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;generateBefore&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">reset</span><span class="o">:</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reset</span><span class="p">,</span> <span class="nx">server</span><span class="o">:</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getServer</span><span class="p">()},</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate Check
opts = {}
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generateCheck: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check plugin count</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">hasPlugins</span><span class="p">()</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">renderNoPlugins</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if the source directory exists</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">srcPath</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check and forward</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">exists</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderNonexistant</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate Clean
opts = {}
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generateClean: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Perform a complete clean of our collections</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">resetCollections</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse the files
opts = {}
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generateParse: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">database = </span><span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="nv">config = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Before</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@emitSync</span> <span class="s">&#39;parseBefore&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">renderParsing</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">      <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>After</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;parseAfter&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">renderParsed</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Documents</p></div></div><div class="code"><div class="wrapper">      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">config</span><span class="p">.</span><span class="nx">documentsPaths</span><span class="p">,</span> <span class="nf">(documentsPath) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">parseDocumentDirectory</span><span class="p">({</span>
          <span class="nv">path: </span><span class="nx">documentsPath</span>
          <span class="nv">collection: </span><span class="nx">database</span>
        <span class="p">},</span><span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Files</p></div></div><div class="code"><div class="wrapper">      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">config</span><span class="p">.</span><span class="nx">filesPaths</span><span class="p">,</span> <span class="nf">(filesPath) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">parseFileDirectory</span><span class="p">({</span>
          <span class="nv">path: </span><span class="nx">filesPath</span>
          <span class="nv">collection: </span><span class="nx">database</span>
        <span class="p">},</span><span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Layouts</p></div></div><div class="code"><div class="wrapper">      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">config</span><span class="p">.</span><span class="nx">layoutsPaths</span><span class="p">,</span> <span class="nf">(layoutsPath) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(complete) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">parseDocumentDirectory</span><span class="p">({</span>
          <span class="nv">path: </span><span class="nx">layoutsPath</span>
          <span class="nv">collection: </span><span class="nx">database</span>
        <span class="p">},</span><span class="nx">complete</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Async</p></div></div><div class="code"><div class="wrapper">      <span class="nx">tasks</span><span class="p">.</span><span class="nx">async</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate Render
opts = {templateData,collection,setProgressIndicator}
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generateRender: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">templateData</span> <span class="o">or=</span> <span class="nx">@getTemplateData</span><span class="p">()</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">collection</span> <span class="o">or=</span> <span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">renderPasses</span> <span class="o">or=</span> <span class="nx">@getConfig</span><span class="p">().</span><span class="nx">renderPasses</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">setProgressIndicator</span> <span class="o">or=</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Contextualize the datbaase, perform two render passes, and perform a write</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span>
      <span class="nv">object: </span><span class="nx">docpad</span>
      <span class="nv">action: </span><span class="s">&#39;contextualizeFiles renderFiles writeFiles&#39;</span>
      <span class="nv">args: </span><span class="p">[</span><span class="nx">opts</span><span class="p">]</span>
      <span class="nv">next: </span><span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate Postpare
opts = {collection}
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generatePostpare: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="nv">database = </span><span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="nv">collection = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">collection</span> <span class="o">or</span> <span class="nx">database</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update generating flag</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad.generating = </span><span class="kc">false</span>
    <span class="nx">collection</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(file) -&gt;</span>
      <span class="k">for</span> <span class="nx">url</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;urls&#39;</span><span class="p">)</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">filesByUrl</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">cid</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire plugins</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;generateAfter&#39;</span><span class="p">,</span> <span class="nx">server</span><span class="o">:</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getServer</span><span class="p">(),</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log generated</p></div></div><div class="code"><div class="wrapper">      <span class="nv">seconds = </span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">lastGenerate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
      <span class="nv">howMany =</span>
        <span class="k">if</span> <span class="nx">collection</span> <span class="o">is</span> <span class="nx">database</span>
          <span class="s">&quot;all </span><span class="si">#{</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">else</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderGenerated</span><span class="p">,</span> <span class="nx">howMany</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">)</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">notify</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">toLocaleTimeString</span><span class="p">(),</span> <span class="nv">title: </span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderGeneratedNotification</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Completed</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Date object of the last generate</p></div></div><div class="code"><div class="wrapper">  <span class="nv">lastGenerate: </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Flag for whether or not we are generating</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generating: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate
next(err)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">generate: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">lastGenerate</span> <span class="o">?=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="s">&#39;1970&#39;</span><span class="p">)</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Progress</p></div></div><div class="code"><div class="wrapper">    <span class="nv">progressIndicator = </span><span class="kc">null</span>
    <span class="nv">opts.setProgressIndicator = </span><span class="nf">(_progressIndicator) -&gt;</span>
      <span class="nv">progressIndicator = </span><span class="nx">_progressIndicator</span>
    <span class="nv">showProgress = </span><span class="nf">-&gt;</span>
      <span class="nv">progress = </span><span class="nx">progressIndicator</span><span class="o">?</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">progress</span>
        <span class="p">[</span><span class="nx">stage</span><span class="p">,</span><span class="nx">completed</span><span class="p">,</span><span class="nx">total</span><span class="p">]</span> <span class="o">=</span> <span class="nx">progress</span>
        <span class="nv">percent = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">completed</span><span class="o">/</span><span class="nx">total</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;%&#39;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderProgress</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">percent</span><span class="p">)</span>
    <span class="nv">progressInterval = </span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">showProgress</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Finish</p></div></div><div class="code"><div class="wrapper">    <span class="nv">finish = </span><span class="nf">(err) -&gt;</span>
      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">progressInterval</span><span class="p">)</span>
      <span class="nv">progressInterval = </span><span class="kc">null</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-load and re-render only what is necessary</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">reset</span><span class="o">?</span> <span class="o">and</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">reset</span> <span class="o">is</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">generatePrepare</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nv">database = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a colelction for the files to reload</p></div></div><div class="code"><div class="wrapper">        <span class="nv">filesToReload = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">filesToReload</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">FilesCollection</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add anything which was modified since our last generate</p></div></div><div class="code"><div class="wrapper">        <span class="nx">filesToReload</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">database</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nv">mtime: $gte: </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">lastGenerate</span><span class="p">).</span><span class="nx">models</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update our generate time</p></div></div><div class="code"><div class="wrapper">        <span class="nv">docpad.lastGenerate = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Perform the reload of the selected files</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">loadFiles</span> <span class="p">{</span><span class="nx">collection</span><span class="o">:</span><span class="nx">filesToReload</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a collection for the files to render</p></div></div><div class="code"><div class="wrapper">          <span class="nv">filesToRender = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">filesToRender</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">FilesCollection</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For anything that gets added, if it is a layout, then add that layouts children too</p></div></div><div class="code"><div class="wrapper">          <span class="nx">filesToRender</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nf">(fileToRender) -&gt;</span>
            <span class="k">if</span> <span class="nx">fileToRender</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;isLayout&#39;</span><span class="p">)</span>
              <span class="nx">filesToRender</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">database</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nv">layout: </span><span class="nx">fileToRender</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">models</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add anything that references other documents (e.g. partials, listing, etc)
if our files to reload aren't all standalone files</p></div></div><div class="code"><div class="wrapper">          <span class="nv">allStandalone = </span><span class="kc">true</span>
          <span class="nx">filesToReload</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(fileToReload) -&gt;</span>
            <span class="k">if</span> <span class="nx">fileToReload</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;standalone&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="kc">true</span>
              <span class="nv">allStandalone = </span><span class="kc">false</span>
              <span class="k">return</span> <span class="kc">false</span>
          <span class="k">if</span> <span class="nx">allStandalone</span> <span class="o">is</span> <span class="kc">false</span>
            <span class="nx">filesToRender</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">database</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nv">referencesOthers: </span><span class="kc">true</span><span class="p">).</span><span class="nx">models</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add anything that was re-loaded</p></div></div><div class="code"><div class="wrapper">          <span class="nx">filesToRender</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">filesToReload</span><span class="p">.</span><span class="nx">models</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Perform the re-render of the selected files</p></div></div><div class="code"><div class="wrapper">          <span class="nx">docpad</span><span class="p">.</span><span class="nx">generateRender</span> <span class="p">{</span><span class="nx">collection</span><span class="o">:</span><span class="nx">filesToRender</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
            <span class="k">return</span> <span class="nx">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Finish up</p></div></div><div class="code"><div class="wrapper">            <span class="nx">docpad</span><span class="p">.</span><span class="nx">generatePostpare</span> <span class="p">{</span><span class="nx">collection</span><span class="o">:</span><span class="nx">filesToRender</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
              <span class="k">return</span> <span class="nx">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-load and re-render everything</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">      <span class="nv">opts.reset = </span><span class="kc">true</span>
      <span class="nv">docpad.lastGenerate = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span>
        <span class="nv">object: </span><span class="nx">docpad</span>
        <span class="nv">action: </span><span class="s">&#39;generatePrepare generateCheck generateClean generateParse generateRender generatePostpare&#39;</span>
        <span class="nv">args: </span><span class="p">[</span><span class="nx">opts</span><span class="p">]</span>
        <span class="nv">next: </span><span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Render</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Flow through a Document
next(err,document)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">flowDocument: </span><span class="nf">(document,opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Flow</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span>
      <span class="nv">object: </span><span class="nb">document</span>
      <span class="nv">action: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">action</span>
      <span class="nv">args: </span><span class="p">[</span><span class="nx">opts</span><span class="p">]</span>
      <span class="nv">next: </span><span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nb">document</span><span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load a Document
next(err,document)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadDocument: </span><span class="nf">(document,opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">action</span> <span class="o">or=</span> <span class="s">&#39;load contextualize&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Flow</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@flowDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load and Render a Document
next(err,document)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">loadAndRenderDocument: </span><span class="nf">(document,opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">action</span> <span class="o">or=</span> <span class="s">&#39;load contextualize render&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Flow</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@flowDocument</span> <span class="nb">document</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="nv">result = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getOutContent</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">next</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">,</span><span class="nb">document</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Document
next(err,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderDocument: </span><span class="nf">(document,opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Path
next(err,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderPath: </span><span class="nf">(path,opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">attributes = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nv">fullPath: </span><span class="nx">path</span>
    <span class="p">},</span><span class="nx">opts</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span> <span class="o">=</span> <span class="nx">@ensureDocument</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span>
    <span class="nx">@loadAndRenderDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Data
next(err,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderData: </span><span class="nf">(content,opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">attributes = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nv">filename: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span>
      <span class="nv">data: </span><span class="nx">content</span>
    <span class="p">},</span><span class="nx">opts</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span> <span class="o">=</span> <span class="nx">@createDocument</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span>
    <span class="nx">@loadAndRenderDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Text
Doesn't extract meta information, or render layouts
next(err,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">renderText: </span><span class="nf">(text,opts,next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">actions</span> <span class="o">?=</span> <span class="p">[</span><span class="s">&#39;renderExtensions&#39;</span><span class="p">,</span><span class="s">&#39;renderDocument&#39;</span><span class="p">]</span>
    <span class="nv">attributes = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="nv">filename: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span>
      <span class="nv">data: </span><span class="nx">text</span>
      <span class="nv">body: </span><span class="nx">text</span>
      <span class="nv">content: </span><span class="nx">text</span>
    <span class="p">},</span><span class="nx">opts</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span> <span class="o">=</span> <span class="nx">@createDocument</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Flow</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span>
      <span class="nv">object: </span><span class="nb">document</span>
      <span class="nv">action: </span><span class="s">&#39;normalize contextualize render&#39;</span>
      <span class="nv">args: </span><span class="p">[</span><span class="nx">opts</span><span class="p">]</span>
      <span class="nv">next: </span><span class="nf">(err) -&gt;</span>
        <span class="nv">result = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getOutContent</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">,</span><span class="nb">document</span><span class="p">)</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render Action
next(err,document,result)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">render: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract document</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nb">document</span>
      <span class="nx">@renderDocument</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nb">document</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">data</span>
      <span class="nx">@renderData</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">text</span>
      <span class="nx">@renderText</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">path = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">path</span> <span class="o">or</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">fullPath</span> <span class="o">or</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span> <span class="o">or</span> <span class="kc">null</span>
      <span class="k">if</span> <span class="nx">path</span>
        <span class="nx">@renderPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">        <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">renderInvalidOptions</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Watch</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Watch</p></div></div><div class="code"><div class="wrapper">  <span class="nv">watch: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="nv">database = </span><span class="nx">@getDatabase</span><span class="p">()</span>
    <span class="nv">watchers = </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Close our watchers</p></div></div><div class="code"><div class="wrapper">    <span class="nv">closeWatchers = </span><span class="nf">-&gt;</span>
      <span class="k">for</span> <span class="nx">watcher</span> <span class="k">in</span> <span class="nx">watchers</span>
        <span class="nx">watcher</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
        <span class="nv">watcher = </span><span class="kc">null</span>
      <span class="nv">watchers = </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Restart our watchers</p></div></div><div class="code"><div class="wrapper">    <span class="nv">resetWatchers = </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Close our watchers</p></div></div><div class="code"><div class="wrapper">      <span class="nx">closeWatchers</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start a group</p></div></div><div class="code"><div class="wrapper">      <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
      <span class="nv">tasks.total = </span><span class="mi">3</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Watch reload paths</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">watchdir</span><span class="p">(</span>
        <span class="nv">paths: </span><span class="nx">_</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">reloadPaths</span><span class="p">,</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">configPaths</span><span class="p">)</span>
        <span class="nv">listeners:</span>
          <span class="s">&#39;log&#39;</span><span class="o">:</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span>
          <span class="s">&#39;error&#39;</span><span class="o">:</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span>
          <span class="s">&#39;change&#39;</span><span class="o">:</span> <span class="nf">-&gt;</span>
            <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchReloadChange</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toLocaleTimeString</span><span class="p">())</span>
            <span class="nx">docpad</span><span class="p">.</span><span class="nx">action</span> <span class="s">&#39;load&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
              <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
              <span class="nx">performGenerate</span><span class="p">(</span><span class="nx">reset</span><span class="o">:</span><span class="kc">true</span><span class="p">)</span>
        <span class="nv">next: </span><span class="nf">(err,_watchers) -&gt;</span>
          <span class="k">for</span> <span class="nx">watcher</span> <span class="k">in</span> <span class="nx">_watchers</span>
            <span class="nx">watchers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span>
          <span class="nx">tasks</span><span class="p">.</span><span class="nx">complete</span><span class="p">()</span>
      <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Watch regenerate paths</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">watchdir</span><span class="p">(</span>
        <span class="nv">paths: </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">regeneratePaths</span>
        <span class="nv">listeners:</span>
          <span class="s">&#39;log&#39;</span><span class="o">:</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span>
          <span class="s">&#39;error&#39;</span><span class="o">:</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span>
          <span class="s">&#39;change&#39;</span><span class="o">:</span> <span class="nf">-&gt;</span> <span class="nx">performGenerate</span><span class="p">(</span><span class="nx">reset</span><span class="o">:</span><span class="kc">true</span><span class="p">)</span>
        <span class="nv">next: </span><span class="nf">(err,_watchers) -&gt;</span>
          <span class="k">for</span> <span class="nx">watcher</span> <span class="k">in</span> <span class="nx">_watchers</span>
            <span class="nx">watchers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span>
          <span class="nx">tasks</span><span class="p">.</span><span class="nx">complete</span><span class="p">()</span>
      <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Watch the source</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">watchdir</span><span class="p">(</span>
        <span class="nv">path: </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">srcPath</span>
        <span class="nv">listeners:</span>
          <span class="s">&#39;log&#39;</span><span class="o">:</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span>
          <span class="s">&#39;error&#39;</span><span class="o">:</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span>
          <span class="s">&#39;change&#39;</span><span class="o">:</span> <span class="nx">changeHandler</span>
        <span class="nv">next: </span><span class="nf">(err,watcher) -&gt;</span>
          <span class="nx">watchers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span>
          <span class="nx">tasks</span><span class="p">.</span><span class="nx">complete</span><span class="p">()</span>
      <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Timer</p></div></div><div class="code"><div class="wrapper">    <span class="nv">regenerateTimer = </span><span class="kc">null</span>
    <span class="nv">regenerateDelay = </span><span class="mi">100</span>
    <span class="nv">queueRegeneration = </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Reset the wait</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">regenerateTimer</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">regenerateTimer</span><span class="p">)</span>
        <span class="nv">regenerateTimer = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Regenerat after a while</p></div></div><div class="code"><div class="wrapper">      <span class="nv">regenerateTimer = </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">performGenerate</span><span class="p">,</span> <span class="nx">regenerateDelay</span><span class="p">)</span>
    <span class="nv">performGenerate = </span><span class="nf">(opts) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">      <span class="nx">opts</span> <span class="o">or=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Do not reset when we do this generate</p></div></div><div class="code"><div class="wrapper">      <span class="nx">opts</span><span class="p">.</span><span class="nx">reset</span> <span class="o">?=</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchRegenerating</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toLocaleTimeString</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Afterwards, re-render anything that should always re-render</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">action</span> <span class="s">&#39;generate&#39;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchRegenerated</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toLocaleTimeString</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Change event handler</p></div></div><div class="code"><div class="wrapper">    <span class="nv">changeHandler = </span><span class="nf">(changeType,filePath,fileCurrentStat,filePreviousStat) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch the file</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchChange</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toLocaleTimeString</span><span class="p">()),</span> <span class="nx">changeType</span><span class="p">,</span> <span class="nx">filePath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we are a file we don't care about
This check should not be needed with v2.3.3 of watchr
however we've still got it here as it may still be an issue</p></div></div><div class="code"><div class="wrapper">      <span class="nv">isIgnored = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">isIgnoredPath</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">isIgnored</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchIgnoredChange</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toLocaleTimeString</span><span class="p">()),</span> <span class="nx">filePath</span>
        <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Don't care if we are a directory</p></div></div><div class="code"><div class="wrapper">      <span class="nv">isDirectory = </span><span class="p">(</span><span class="nx">fileCurrentStat</span> <span class="o">or</span> <span class="nx">filePreviousStat</span><span class="p">).</span><span class="nx">isDirectory</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">isDirectory</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchDirectoryChange</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toLocaleTimeString</span><span class="p">()),</span> <span class="nx">filePath</span>
        <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Override the stat's mtime to now
This is because renames will not update the mtime</p></div></div><div class="code"><div class="wrapper">      <span class="nx">fileCurrentStat</span><span class="o">?</span><span class="p">.</span><span class="nv">mtime = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the file object</p></div></div><div class="code"><div class="wrapper">      <span class="nv">file = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">ensureFileOrDocument</span><span class="p">({</span><span class="nx">fullPath</span><span class="o">:</span><span class="nx">filePath</span><span class="p">},{</span><span class="nx">stat</span><span class="o">:</span><span class="nx">fileCurrentStat</span><span class="p">})</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">setStat</span><span class="p">(</span><span class="nx">fileCurrentStat</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">changeType</span> <span class="o">is</span> <span class="s">&#39;update&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>File was deleted, delete the rendered file, and remove it from the database</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">changeType</span> <span class="o">is</span> <span class="s">&#39;delete&#39;</span>
        <span class="nx">database</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">delete</span> <span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">queueRegeneration</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>File is new or was changed, update it's mtime by setting the stat</p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span> <span class="k">if</span> <span class="nx">changeType</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;create&#39;</span><span class="p">,</span><span class="s">&#39;update&#39;</span><span class="p">]</span>
        <span class="nx">queueRegeneration</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Watch</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchStart</span><span class="p">)</span>
    <span class="nx">resetWatchers</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">watchStarted</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Run Action</p></div></div><div class="code"><div class="wrapper">  <span class="nv">run: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">srcPath = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">srcPath</span>
    <span class="nv">destinationPath = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">rootPath</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Run docpad</p></div></div><div class="code"><div class="wrapper">    <span class="nv">runDocpad = </span><span class="nf">-&gt;</span>
      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">flow</span><span class="p">(</span>
        <span class="nv">object: </span><span class="nx">docpad</span>
        <span class="nv">action: </span><span class="s">&#39;server generate watch&#39;</span>
        <span class="nv">args: </span><span class="p">[</span><span class="nx">opts</span><span class="p">]</span>
        <span class="nv">next: </span><span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we have the docpad structure</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">srcPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We have the correct structure, so let's proceed with DocPad</p></div></div><div class="code"><div class="wrapper">      <span class="nx">runDocpad</span><span class="p">()</span>
    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We don't have the correct structure
Check if we are running on an empty directory</p></div></div><div class="code"><div class="wrapper">      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">destinationPath</span><span class="p">,</span> <span class="nf">(err,files) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if our directory is empty</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It isn't empty, display a warning</p></div></div><div class="code"><div class="wrapper">          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="o">+</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">skeletonNonexistant</span><span class="p">,</span> <span class="nx">destinationPath</span><span class="p">))</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">skeleton</span> <span class="nx">opts</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">runDocpad</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Skeleton</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skeleton</p></div></div><div class="code"><div class="wrapper">  <span class="nv">skeleton: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">skeletonId = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">skeleton</span>
    <span class="nv">srcPath = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">srcPath</span>
    <span class="nv">destinationPath = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">rootPath</span>
    <span class="nv">selectSkeletonCallback = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">selectSkeletonCallback</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use a Skeleton</p></div></div><div class="code"><div class="wrapper">    <span class="nv">useSkeleton = </span><span class="nf">(skeletonModel) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Track</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="s">&#39;skeleton-use&#39;</span><span class="p">,{</span><span class="nx">skeletonId</span><span class="o">:</span><span class="nx">skeletonModel</span><span class="p">.</span><span class="nx">id</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">skeletonInstall</span><span class="p">,</span> <span class="nx">skeletonModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span> <span class="nx">destinationPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install Skeleton</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">installSkeleton</span> <span class="nx">skeletonModel</span><span class="p">,</span> <span class="nx">destinationPath</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-load configuration</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">load</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">          <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">skeletonInstalled</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Forward</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use No Skeleton</p></div></div><div class="code"><div class="wrapper">    <span class="nv">useNoSkeleton = </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Track</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="s">&#39;skeleton-use&#39;</span><span class="p">,{</span><span class="nx">skeletonId</span><span class="o">:</span><span class="s">&#39;none&#39;</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the paths</p></div></div><div class="code"><div class="wrapper">      <span class="nx">balUtil</span><span class="p">.</span><span class="nx">ensurePath</span> <span class="nx">srcPath</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error?</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Group</p></div></div><div class="code"><div class="wrapper">        <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">Group</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
        <span class="nv">tasks.total = </span><span class="mi">3</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create</p></div></div><div class="code"><div class="wrapper">        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">ensurePath</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">documentsPaths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">completer</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create</p></div></div><div class="code"><div class="wrapper">        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">ensurePath</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">layoutsPaths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">completer</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create</p></div></div><div class="code"><div class="wrapper">        <span class="nx">balUtil</span><span class="p">.</span><span class="nx">ensurePath</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">filesPaths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">completer</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if already exists</p></div></div><div class="code"><div class="wrapper">    <span class="nx">balUtil</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">srcPath</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">exists</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">skeletonExists</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Track</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="s">&#39;skeleton-ask&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Do we already have a skeletonId selected?</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">skeletonId</span>
        <span class="nx">useSkeleton</span><span class="p">()</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the available skeletons</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">getSkeletons</span> <span class="nf">(err,skeletonsCollection) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Provide selection to the interface</p></div></div><div class="code"><div class="wrapper">          <span class="nx">selectSkeletonCallback</span> <span class="nx">skeletonsCollection</span><span class="p">,</span> <span class="nf">(err,skeletonModel) -&gt;</span>
            <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span>
            <span class="k">if</span> <span class="nx">skeletonModel</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span> <span class="o">or</span> <span class="nx">skeletonModel</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="s">&#39;none&#39;</span>
              <span class="nx">useNoSkeleton</span><span class="p">()</span>
            <span class="k">else</span>
              <span class="nx">useSkeleton</span><span class="p">(</span><span class="nx">skeletonModel</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>Server</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serve Document</p></div></div><div class="code"><div class="wrapper">  <span class="nv">serveDocument: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="p">{</span><span class="nb">document</span><span class="p">,</span><span class="nx">err</span><span class="p">,</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">}</span> <span class="o">=</span> <span class="nx">opts</span>
    <span class="nv">docpad = </span><span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If no document, then exit early</p></div></div><div class="code"><div class="wrapper">    <span class="k">unless</span> <span class="nb">document</span>
      <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Content Type</p></div></div><div class="code"><div class="wrapper">    <span class="nv">contentType = </span><span class="nb">document</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;outContentType&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nb">document</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;contentType&#39;</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="nx">contentType</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Send</p></div></div><div class="code"><div class="wrapper">    <span class="nv">dynamic = </span><span class="nb">document</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;dynamic&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">dynamic</span>
      <span class="nv">templateData = </span><span class="nx">balUtil</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">req</span><span class="p">.</span><span class="nx">templateData</span> <span class="o">or</span> <span class="p">{},</span> <span class="p">{</span><span class="nx">req</span><span class="p">,</span><span class="nx">err</span><span class="p">})</span>
      <span class="nv">templateData = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getTemplateData</span><span class="p">(</span><span class="nx">templateData</span><span class="p">)</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">render</span> <span class="p">{</span><span class="nx">templateData</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
        <span class="nv">content = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getOutContent</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">docpad</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="o">?</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">content = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getOutContent</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">content</span>
        <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="o">?</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="o">?</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Server Middleware: Header</p></div></div><div class="code"><div class="wrapper">  <span class="nv">serverMiddlewareHeader: </span><span class="nf">(req,res,next) -&gt;</span>
    <span class="nv">tools = </span><span class="nx">res</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;X-Powered-By&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[,\s]+/g</span><span class="p">)</span>
    <span class="nx">tools</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;DocPad&#39;</span>
    <span class="nv">tools = </span><span class="nx">tools</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;X-Powered-By&#39;</span><span class="p">,</span><span class="nx">tools</span><span class="p">)</span>
    <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Server Middleware: Router</p></div></div><div class="code"><div class="wrapper">  <span class="nv">serverMiddlewareRouter: </span><span class="nf">(req,res,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we are generating then wait until generation is complete before continuing</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">lastGenerate</span> <span class="o">is</span> <span class="kc">null</span> <span class="o">or</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">generating</span> <span class="o">is</span> <span class="kc">true</span>
      <span class="nx">docpad</span><span class="p">.</span><span class="nx">once</span> <span class="s">&#39;generateAfter&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
        <span class="k">return</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">serverMiddlewareRouter</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">cleanUrl = </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\?.*/</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="nv">file = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getFileByUrl</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="o">or</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getFileByUrl</span><span class="p">(</span><span class="nx">cleanUrl</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">file</span><span class="o">?</span> <span class="o">is</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we are the desired url
if we aren't do a permanent redirect</p></div></div><div class="code"><div class="wrapper">    <span class="nv">url = </span><span class="nx">file</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">url</span> <span class="o">isnt</span> <span class="nx">cleanUrl</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">url</span> <span class="o">isnt</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span><span class="nx">url</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serve the file to the user</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">serveDocument</span><span class="p">({</span><span class="nb">document</span><span class="o">:</span><span class="nx">file</span><span class="p">,</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Server Middleware: 404</p></div></div><div class="code"><div class="wrapper">  <span class="nv">serverMiddleware404: </span><span class="nf">(req,res,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">database = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">database</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serve the document to the user</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span> <span class="o">=</span> <span class="nx">database</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">relativeOutPath: </span><span class="s">&#39;404.html&#39;</span><span class="p">})</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">serveDocument</span><span class="p">({</span><span class="nb">document</span><span class="p">,</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">,</span><span class="nx">statusCode</span><span class="o">:</span><span class="mi">404</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Server Middleware: 500</p></div></div><div class="code"><div class="wrapper">  <span class="nv">serverMiddleware500: </span><span class="nf">(err,req,res,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">database = </span><span class="nx">docpad</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>  <span class="k">unless</span> <span class="nx">database</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serve the document to the user</p></div></div><div class="code"><div class="wrapper">    <span class="nb">document</span> <span class="o">=</span> <span class="nx">database</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">relativeOutPath: </span><span class="s">&#39;500.html&#39;</span><span class="p">})</span>
    <span class="nx">docpad</span><span class="p">.</span><span class="nx">serveDocument</span><span class="p">({</span><span class="nb">document</span><span class="p">,</span><span class="nx">err</span><span class="p">,</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">,</span><span class="nx">statusCode</span><span class="o">:</span><span class="mi">500</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Server</p></div></div><div class="code"><div class="wrapper">  <span class="nv">server: </span><span class="nf">(opts,next) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Requires</p></div></div><div class="code"><div class="wrapper">    <span class="nv">http = </span><span class="kc">null</span>
    <span class="nv">express = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prepare</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balUtil</span><span class="p">.</span><span class="nx">extractOptsAndCallback</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span>
    <span class="nv">docpad = </span><span class="nx">@</span>
    <span class="nv">config = </span><span class="nx">@config</span>
    <span class="nv">locale = </span><span class="nx">@getLocale</span><span class="p">()</span>
    <span class="nv">port = </span><span class="nx">@getPort</span><span class="p">()</span>
    <span class="nv">serverExpress = </span><span class="kc">null</span>
    <span class="nv">serverHttp = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Config</p></div></div><div class="code"><div class="wrapper">    <span class="nx">opts</span><span class="p">.</span><span class="nx">middlewareBodyParser</span> <span class="o">?=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middlewareBodyParser</span> <span class="o">?</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middlewareStandard</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">middlewareMethodOverride</span> <span class="o">?=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middlewareMethodOverride</span> <span class="o">?</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middlewareStandard</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">middlewareExpressRouter</span> <span class="o">?=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middlewareExpressRouter</span> <span class="o">?</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middlewareStandard</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">middleware404</span> <span class="o">?=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middleware404</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">middleware500</span> <span class="o">?=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">middleware500</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Finish</p></div></div><div class="code"><div class="wrapper">    <span class="nv">finish = </span><span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Plugins</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;serverAfter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">server</span><span class="o">:</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverHttp</span><span class="p">,</span><span class="nx">express</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start Server</p></div></div><div class="code"><div class="wrapper">    <span class="nv">startServer = </span><span class="nf">(next) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Catch</p></div></div><div class="code"><div class="wrapper">      <span class="nx">serverHttp</span><span class="p">.</span><span class="nx">once</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Friendlify the error message if it is what we suspect it is</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;EADDRINUSE&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">serverInUse</span><span class="p">,</span> <span class="nx">port</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Listen</p></div></div><div class="code"><div class="wrapper">      <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">serverStart</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">outPath</span><span class="p">)</span>
      <span class="nx">serverHttp</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span><span class="p">,</span>  <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log</p></div></div><div class="code"><div class="wrapper">        <span class="nv">address = </span><span class="nx">serverHttp</span><span class="p">.</span><span class="nx">address</span><span class="p">()</span>
        <span class="nv">serverHostname = </span><span class="k">if</span> <span class="nx">address</span><span class="p">.</span><span class="nx">address</span> <span class="o">is</span> <span class="s">&#39;0.0.0.0&#39;</span> <span class="k">then</span> <span class="s">&#39;localhost&#39;</span> <span class="k">else</span> <span class="nx">address</span><span class="p">.</span><span class="nx">address</span>
        <span class="nv">serverPort = </span><span class="nx">address</span><span class="p">.</span><span class="nx">port</span>
        <span class="nv">serverLocation = </span><span class="s">&quot;http://</span><span class="si">#{</span><span class="nx">serverHostname</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">serverPort</span><span class="si">}</span><span class="s">/&quot;</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">locale</span><span class="p">.</span><span class="nx">serverStarted</span><span class="p">,</span> <span class="nx">serverLocation</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">outPath</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Done</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start</p></div></div><div class="code"><div class="wrapper">    <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;serverBefore&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Server</p></div></div><div class="code"><div class="wrapper">      <span class="p">{</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverHttp</span><span class="p">}</span> <span class="o">=</span> <span class="nx">docpad</span><span class="p">.</span><span class="nx">getServer</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">serverExpress</span> <span class="o">and</span> <span class="o">!</span><span class="nx">serverHttp</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Require</p></div></div><div class="code"><div class="wrapper">        <span class="nx">http</span> <span class="o">?=</span> <span class="nx">require</span><span class="p">(</span><span class="s">&#39;http&#39;</span><span class="p">)</span>
        <span class="nx">express</span> <span class="o">?=</span> <span class="nx">require</span><span class="p">(</span><span class="s">&#39;express&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create</p></div></div><div class="code"><div class="wrapper">        <span class="nv">serverExpress = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">serverExpress</span> <span class="o">or</span> <span class="nx">express</span><span class="p">()</span>
        <span class="nv">serverHttp = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">serverHttp</span> <span class="o">or</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">serverExpress</span><span class="p">)</span>
        <span class="nx">docpad</span><span class="p">.</span><span class="nx">setServer</span><span class="p">({</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverHttp</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extend the server</p></div></div><div class="code"><div class="wrapper">      <span class="k">unless</span> <span class="nx">config</span><span class="p">.</span><span class="nx">extendServer</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start the Server</p></div></div><div class="code"><div class="wrapper">        <span class="nx">startServer</span><span class="p">(</span><span class="nx">finish</span><span class="p">)</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Require</p></div></div><div class="code"><div class="wrapper">        <span class="nx">express</span> <span class="o">?=</span> <span class="nx">require</span><span class="p">(</span><span class="s">&#39;express&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>POST Middleware</p></div></div><div class="code"><div class="wrapper">        <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">())</span>  <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">middlewareBodyParser</span> <span class="o">isnt</span> <span class="kc">false</span>
        <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">())</span>  <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">middlewareMethodOverride</span> <span class="o">isnt</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Emit the serverExtend event
So plugins can define their routes earlier than the DocPad routes</p></div></div><div class="code"><div class="wrapper">        <span class="nx">docpad</span><span class="p">.</span><span class="nx">emitSync</span> <span class="s">&#39;serverExtend&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">server</span><span class="o">:</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverExpress</span><span class="p">,</span><span class="nx">serverHttp</span><span class="p">,</span><span class="nx">express</span><span class="p">},</span> <span class="nf">(err) -&gt;</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">err</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad Header Middleware
Keep it after the serverExtend event</p></div></div><div class="code"><div class="wrapper">          <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">serverMiddlewareHeader</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Router Middleware
Keep it after the serverExtend event</p></div></div><div class="code"><div class="wrapper">          <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">serverExpress</span><span class="p">.</span><span class="nx">router</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">middlewareExpressRouter</span> <span class="o">isnt</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad Router Middleware
Keep it after the serverExtend event</p></div></div><div class="code"><div class="wrapper">          <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">serverMiddlewareRouter</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Static
Keep it after the serverExtend event</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">maxAge</span>
            <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">outPath</span><span class="p">,{</span><span class="nx">maxAge</span><span class="o">:</span><span class="nx">config</span><span class="p">.</span><span class="nx">maxAge</span><span class="p">}))</span>
          <span class="k">else</span>
            <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">outPath</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad 404 Middleware
Keep it after the serverExtend event</p></div></div><div class="code"><div class="wrapper">          <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">serverMiddleware404</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">middleware404</span> <span class="o">isnt</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>DocPad 500 Middleware
Keep it after the serverExtend event</p></div></div><div class="code"><div class="wrapper">          <span class="nx">serverExpress</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">docpad</span><span class="p">.</span><span class="nx">serverMiddleware500</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">middleware500</span> <span class="o">isnt</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Start the Server</p></div></div><div class="code"><div class="wrapper">        <span class="nx">startServer</span><span class="p">(</span><span class="nx">finish</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>=====================================
Export</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Export</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports =</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Modules</p></div></div><div class="code"><div class="wrapper">  <span class="nv">DocPad: </span><span class="nx">DocPad</span>
  <span class="nv">queryEngine: </span><span class="nx">queryEngine</span>
  <span class="nv">Backbone: </span><span class="nx">Backbone</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create Instance
Wrapper for creating a DocPad instance
good for future compatibility in case the API changes</p></div></div><div class="code"><div class="wrapper">  <span class="nv">createInstance: </span><span class="nf">(args...) -&gt;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">DocPad</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span></div></div></div></div></body></html>